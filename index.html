<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhnField</title>

<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

<link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet">
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/flatgeobuf/dist/flatgeobuf-geojson.min.js"></script>

<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://unpkg.com/y-webrtc@10.6.9/dist/y-webrtc.min.js"></script>
<script src="https://unpkg.com/y-indexeddb@1.3.9/dist/y-indexeddb.js"></script>

<!-- 共有URL用に圧縮 -->
<script src="https://unpkg.com/lz-string@1.4.4/libs/lz-string.min.js"></script>

<style>
  html, body, #map { height:100%; margin:0; }
  .toolbar{
    position:absolute; top:60px; left:10px; z-index:999;
    width:270px; background:#fff; padding:12px; border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.15); font-family:system-ui, sans-serif;
  }
  .toolbar h1{ font-size:16px; margin:0 0 6px; }
  .toolbar .small{ font-size:12px; color:#555; margin:0 0 10px; word-break:break-all; }
  .toolbar button{ width:100%; margin:6px 0; padding:10px 12px; font-size:15px;
    border:1px solid #ccc; border-radius:8px; background:#f8f8f8; text-align:left; cursor:pointer; }
  .toolbar button:hover{ background:#eee; }
  .toolbar button.active{ background:#dff0ff; border-color:#2b7fff; }
  .row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
  .row label{ width:74px; font-size:12px; }
  .row input[type="color"]{ width:40px; height:28px; border:none; background:none; padding:0; }
  .row input[type="range"]{ flex:1; }
  .hr{ border-top:1px solid #e6e6e6; margin:10px 0; }
  .comment-label{
    background: rgba(0,0,0,0.85); color:#fff; border-radius:6px; padding:4px 8px; font-size:12px;
    box-shadow:0 1px 6px rgba(0,0,0,.25); pointer-events:none; max-width:220px; line-height:1.35;
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="toolbar">
  <h1>PhnField</h1>
  <div id="status" class="small">起動中…</div>

  <button id="btn-share">共同編集URLを生成してコピー（短縮）</button>
  <div class="hr"></div>

  <button id="btn-select"  class="active">選択/移動</button>
  <button id="btn-point">点</button>
  <button id="btn-line">線（ダブルクリック確定）</button>
  <button id="btn-polygon">ポリゴン（ダブルクリック確定）</button>
  <button id="btn-arrow">矢印（線の終点に矢じり）</button>
  <button id="btn-circle">円（中心→移動→クリックで確定）</button>
  <button id="btn-trash">選択を削除</button>

  <div class="hr"></div>
  <div class="row"><label>線色</label><input type="color" id="stroke" value="#2b7fff"><input id="strokeW" type="range" min="1" max="10" step="1" value="3"></div>
  <div class="row"><label>面色</label><input type="color" id="fill" value="#3b82f6"><input id="fillO" type="range" min="0" max="1" step="0.05" value="0.25"></div>
  <div class="row"><button id="btn-apply-selected">選択に適用</button><button id="btn-apply-all">全体に適用</button></div>

  <div class="hr"></div>
  <button id="btn-save-geojson">GeoJSONで保存</button>
  <button id="btn-save-fgb">FlatGeobufで保存</button>
  <button id="btn-clear">全削除</button>
  <button id="btn-toggle-labels">コメント表示 切替</button>
  <button id="btn-toggle-basemap">地図切替（GSI⇄OSM⇄写真）</button>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const setStatus = (s)=>{ const el=$('status'); if(el) el.textContent=s; };
  const setActive = (id)=>{ document.querySelectorAll('.toolbar button').forEach(b=>b.classList.remove('active')); $(id)?.classList.add('active'); };

  // ---- room / 共有URL（短縮ハッシュは任意） ----
  function ensureRoom(){
    const u = new URL(location.href);
    if (!u.searchParams.get('room')) {
      const id = 'r' + crypto.getRandomValues(new Uint32Array(1))[0].toString(36).slice(0,6);
      u.searchParams.set('room', id);
      history.replaceState({}, '', u);
    }
    return new URL(location.href);
  }
  $('btn-share').onclick = async ()=>{
    const url = ensureRoom();
    // 共有データは圧縮して #c= に（任意・短い）
    const fc = Draw.getAll();
    const c = LZString.compressToEncodedURIComponent(JSON.stringify(fc));
    url.hash = 'c=' + c;
    const s = url.toString();
    try { await navigator.clipboard.writeText(s); alert('コピーしました：\n' + s); }
    catch { prompt('このURLをコピーしてください', s); }
  };

  const roomName = (new URL(location.href)).searchParams.get("room") || "default";

  // ---- basemap ----
  const map = new maplibregl.Map({
    container:'map',
    style:{
      version:8,
      sources:{
        gsi:{ type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize:256,
              attribution:"地理院タイル（<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank' rel='noopener'>出典</a>)"},
        osm:{ type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256,
              attribution:"© OpenStreetMap contributors" },
        photo:{ type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'], tileSize:256,
              attribution:"地理院タイル（全国最新写真）"}
      },
      layers:[
        {id:'basemap-gsi', type:'raster', source:'gsi', layout:{visibility:'visible'}},
        {id:'basemap-osm', type:'raster', source:'osm', layout:{visibility:'none'}},
        {id:'basemap-photo', type:'raster', source:'photo', layout:{visibility:'none'}}
      ]
    },
    center:[135.8049,34.6851], zoom:12, attributionControl:true
  });
  map.addControl(new maplibregl.NavigationControl(),'top-right');
  map.addControl(new maplibregl.AttributionControl({compact:false}), 'bottom-right');
  let basemap='GSI';

  // ---- Draw（アクティブ時のプレビューを表示、インアクティブは非表示） ----
  const drawStyles = [
    // --- active プレビューは見える ---
    { id:'gl-draw-polygon-fill-active', type:'fill',
      filter:['all',['==','active','true'],['==',['geometry-type'],'Polygon']],
      paint:{'fill-color':'#66aaff','fill-opacity':0.2} },
    { id:'gl-draw-polygon-stroke-active', type:'line',
      filter:['all',['==','active','true'],['==',['geometry-type'],'Polygon']],
      paint:{'line-color':'#2b7fff','line-width':2} },
    { id:'gl-draw-line-active', type:'line',
      filter:['all',['==','active','true'],['==',['geometry-type'],'LineString']],
      paint:{'line-color':'#2b7fff','line-width':3} },
    { id:'gl-draw-vertex-halo-active', type:'circle',
      filter:['all',['==','active','true'],['==','meta','vertex']],
      paint:{'circle-radius':6,'circle-color':'#fff'} },
    { id:'gl-draw-vertex-active', type:'circle',
      filter:['all',['==','active','true'],['==','meta','vertex']],
      paint:{'circle-radius':3,'circle-color':'#2b7fff'} },
    // --- inactive を消す（自前レイヤで描画するため） ---
    { id:'gl-draw-polygon-fill-inactive', type:'fill',
      filter:['all',['==','active','false'],['==',['geometry-type'],'Polygon']],
      paint:{'fill-opacity':0} },
    { id:'gl-draw-polygon-stroke-inactive', type:'line',
      filter:['all',['==','active','false'],['==',['geometry-type'],'Polygon']],
      paint:{'line-width':0} },
    { id:'gl-draw-line-inactive', type:'line',
      filter:['all',['==','active','false'],['==',['geometry-type'],'LineString']],
      paint:{'line-width':0} },
    // 点は自前ピンで描く
    { id:'gl-draw-point-inactive', type:'circle',
      filter:['all',['==','active','false'],['==',['geometry-type'],'Point']],
      paint:{'circle-radius':0} },
    { id:'gl-draw-point-active', type:'circle',
      filter:['all',['==','active','true'],['==',['geometry-type'],'Point']],
      paint:{'circle-radius':0} },
  ];
  const Draw = new MapboxDraw({ displayControlsDefault:false, defaultMode:'simple_select', styles:drawStyles });
  map.addControl(Draw,'top-left');

  // ---- 自前レイヤ（完成図を描く） ----
  map.on('load', ()=>{
    // ピン（SVG：北向き）
    if(!map.hasImage('phn-pin')){
      const svgPin = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
        <path fill='#E52525' d='M32 2C20.4 2 11 11.4 11 23c0 14.5 21 39 21 39s21-24.5 21-39C53 11.4 43.6 2 32 2z'/>
        <circle cx='32' cy='23' r='9' fill='#fff'/></svg>`;
      const img = new Image(); img.onload=()=>map.addImage('phn-pin', img, {pixelRatio:2});
      img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgPin);
    }
    // 矢印ヘッド（北向き三角） → bearingで回転
    if(!map.hasImage('arrow-head')){
      const svgA = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
        <path d='M32 6 L52 40 L12 40 Z' fill='#111'/></svg>`;
      const img = new Image(); img.onload=()=>map.addImage('arrow-head', img, {pixelRatio:2});
      img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgA);
    }

    map.addSource('phn-style',{type:'geojson',data:{type:'FeatureCollection',features:[]}});

    map.addLayer({id:'phn-fill',type:'fill',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'fill-color':['coalesce',['get','fill'],'#3b82f6'],'fill-opacity':['coalesce',['get','fill-opacity'],0.25]}});
    map.addLayer({id:'phn-outline',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3]}});
    map.addLayer({id:'phn-line',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'LineString'],
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3],'line-cap':'round','line-join':'round'}});
    map.addLayer({id:'phn-point',type:'symbol',source:'phn-style',
      filter:['==',['geometry-type'],'Point'],
      layout:{'icon-image':'phn-pin','icon-size':0.9,'icon-allow-overlap':true}});

    map.addSource('arrow-points',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:'arrow-points-layer',type:'symbol',source:'arrow-points',
      layout:{'icon-image':'arrow-head','icon-size':1.0,'icon-rotation-alignment':'map','icon-rotate':['get','bearing'],'icon-allow-overlap':true}});

    map.addSource('circle-preview',{type:'geojson',data:{type:'FeatureCollection',features:[]}}),
    map.addLayer({id:'circle-preview-fill',type:'fill',source:'circle-preview',paint:{'fill-color':'#1e90ff','fill-opacity':0.2}});
    map.addLayer({id:'circle-preview-line',type:'line',source:'circle-preview',paint:{'line-color':'#1e90ff','line-width':3,'line-dasharray':[2,1]}});

    refreshStyle();
    // 共有URLの短縮ハッシュ #c= があれば初期化
    const h = new URL(location.href).hash;
    if(h.startsWith('#c=')){
      try{
        const fc = JSON.parse(LZString.decompressFromEncodedURIComponent(h.slice(3)) || 'null');
        if(fc && fc.type==='FeatureCollection'){ Draw.deleteAll(); Draw.add(fc); refreshStyle(); syncToY(); }
      }catch{}
    }
  });

  function refreshStyle(){
    const fc = Draw.getAll();
    if(map.getSource('phn-style')) map.getSource('phn-style').setData(fc);
    updateLabels(); updateArrowHeads();
  }

  // ---- P2P + IndexedDB（永続） ----
  let ydoc=null, provider=null, yfeatures=null, realtime=false;
  try{
    if(window.ywebrtc && window.Y){
      ydoc=new Y.Doc();
      new window.yIndexeddb.IndexeddbPersistence('phnfield-'+roomName, ydoc);
      provider=new ywebrtc.WebrtcProvider('phnfield-'+roomName, ydoc, { signaling:['wss://signaling.yjs.dev'] });
      yfeatures=ydoc.getArray('features');
      yfeatures.observe(()=>{ const arr=yfeatures.toArray(); Draw.deleteAll(); if(arr.length) Draw.add({type:'FeatureCollection',features:arr}); refreshStyle(); });
      realtime=true;
      setStatus('リアルタイム同期：接続中（room='+roomName+'）');
      provider.on('status', e=> setStatus('リアルタイム同期：'+e.status+'（room='+roomName+'）'));
    }else throw new Error();
  }catch{ setStatus('ローカル編集（同期なし）'); }
  const syncToY=()=>{ if(!realtime) return; const a=Draw.getAll().features; ydoc.transact(()=>{ yfeatures.delete(0,yfeatures.length); yfeatures.push(a); }); };

  // ---- コメント・ラベル・矢印 ----
  let showLabels=true;
  function updateLabels(){
    document.querySelectorAll('.mapboxgl-marker').forEach(m=>m.remove());
    if(!showLabels) return;
    Draw.getAll().features.forEach(f=>{
      const c=f.properties?.comment||''; if(!c) return;
      let ll = (f.geometry.type==='Point') ? f.geometry.coordinates
             : (f.geometry.type==='LineString') ? f.geometry.coordinates[0]
             : f.geometry.coordinates[0][0];
      const el=document.createElement('div'); el.className='comment-label'; el.textContent=c;
      new maplibregl.Marker({element:el}).setLngLat(ll).addTo(map);
    });
  }
  function updateArrowHeads(){
    if(!map.getSource('arrow-points')) return;
    const feats=[];
    Draw.getAll().features.forEach(f=>{
      if(f.geometry.type==='LineString' && f.properties?.arrow===true){
        const cs=f.geometry.coordinates; if(cs.length<2) return;
        const a=cs[cs.length-2], b=cs[cs.length-1];
        const bearing=turf.bearing(turf.point(a), turf.point(b)); // 北=0°
        feats.push({type:'Feature',geometry:{type:'Point',coordinates:b},properties:{bearing}});
      }
    });
    map.getSource('arrow-points').setData({type:'FeatureCollection',features:feats});
  }

  // ---- 円モード（OK版を踏襲） ----
  let circleMode=false, circleCenter=null;
  function exitCircle(){ circleMode=false; circleCenter=null; map.getSource('circle-preview')?.setData({type:'FeatureCollection',features:[]}); map.getCanvas().style.cursor=''; }
  function circlePreview(center, ll){
    if(!center||!ll) return;
    const r=turf.distance(turf.point(center), turf.point([ll.lng,ll.lat]), {units:'kilometers'})*1000;
    const poly=turf.circle(center, Math.max(r,1), {steps:64, units:'meters'});
    map.getSource('circle-preview').setData(poly);
  }
  map.on('mousemove', e=>{ if(circleMode && circleCenter) circlePreview(circleCenter, e.lngLat); });
  map.on('touchmove', e=>{ if(circleMode && circleCenter){ const t=e.originalEvent.touches?.[0]; if(t) circlePreview(circleCenter, map.unproject([t.clientX,t.clientY])); }});
  map.on('click', e=>{
    if(!circleMode) return;
    if(!circleCenter){ circleCenter=[e.lngLat.lng,e.lngLat.lat]; circlePreview(circleCenter, e.lngLat); }
    else{
      const r=turf.distance(turf.point(circleCenter),turf.point([e.lngLat.lng,e.lngLat.lat]),{units:'kilometers'})*1000;
      const poly=turf.circle(circleCenter, Math.max(r,1), {steps:64, units:'meters'});
      const id=Draw.add({type:'Feature', geometry:poly.geometry, properties:{shape:'circle', radius_m:Math.round(r)}});
      exitCircle(); finishWithComment(id);
    }
  });

  // ---- モード切替 & プレビュー維持（線/面） ----
  map.on('draw.modechange', e=>{
    const m=e.mode;
    (m==='draw_line_string'||m==='draw_polygon') ? map.doubleClickZoom.disable() : map.doubleClickZoom.enable();
    if(m!=='draw_point' && m!=='draw_line_string' && m!=='draw_polygon'){ exitCircle(); arrowMode=false; setActive('btn-select'); }
  });

  // ---- UI ----
  let arrowMode=false;
  $('btn-select').onclick  = ()=>{ Draw.changeMode('simple_select'); setActive('btn-select'); exitCircle(); arrowMode=false; };
  $('btn-point').onclick   = ()=>{ Draw.changeMode('draw_point'); setActive('btn-point'); exitCircle(); arrowMode=false; };
  $('btn-line').onclick    = ()=>{ Draw.changeMode('draw_line_string'); setActive('btn-line'); exitCircle(); arrowMode=false; };
  $('btn-polygon').onclick = ()=>{ Draw.changeMode('draw_polygon'); setActive('btn-polygon'); exitCircle(); arrowMode=false; };
  $('btn-arrow').onclick   = ()=>{ arrowMode=true; Draw.changeMode('draw_line_string'); setActive('btn-arrow'); exitCircle(); setStatus('矢印：線の終点に矢じり'); };
  $('btn-circle').onclick  = ()=>{ circleMode=true; circleCenter=null; map.getCanvas().style.cursor='crosshair'; setActive('btn-circle'); arrowMode=false; };
  $('btn-trash').onclick   = ()=>{ Draw.trash(); refreshStyle(); syncToY(); };

  // ---- 生成/更新/削除 ----
  function finishWithComment(id){
    requestAnimationFrame(()=>{
      const c = prompt('コメントを入力（任意）') ?? '';
      Draw.setFeatureProperty(id, 'comment', c);
      refreshStyle(); syncToY();
      setTimeout(()=>{ Draw.changeMode('simple_select'); setActive('btn-select'); map.doubleClickZoom.enable(); },0);
    });
  }
  map.on('draw.create', e=>{
    const f=e.features[0];
    if(arrowMode && f.geometry.type==='LineString') Draw.setFeatureProperty(f.id,'arrow',true);
    finishWithComment(f.id);
    arrowMode=false;
  });
  map.on('draw.update', ()=>{ refreshStyle(); syncToY(); });
  map.on('draw.delete', ()=>{ refreshStyle(); syncToY(); });
  map.on('draw.render', updateArrowHeads); // 編集中の矢じりも追随

  // ---- スタイル適用 ----
  function applyStyle(feats){
    const s=$('stroke').value, w=+$('strokeW').value, f=$('fill').value, o=parseFloat($('fillO').value);
    feats.forEach(ft=>{
      Draw.setFeatureProperty(ft.id,'stroke',s);
      Draw.setFeatureProperty(ft.id,'stroke-width',w);
      if(ft.geometry.type==='Polygon'){ Draw.setFeatureProperty(ft.id,'fill',f); Draw.setFeatureProperty(ft.id,'fill-opacity',o); }
    });
    refreshStyle(); syncToY();
  }
  $('btn-apply-selected').onclick = ()=>{ const sel=Draw.getSelected().features; if(!sel.length){alert('図形を選択してください');return;} applyStyle(sel); };
  $('btn-apply-all').onclick      = ()=> applyStyle(Draw.getAll().features);

  // ---- 保存など ----
  function download(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
  $('btn-save-geojson').onclick = ()=> download('phnfield.geojson', new Blob([JSON.stringify(Draw.getAll(),null,2)],{type:'application/geo+json'}));
  $('btn-save-fgb').onclick     = ()=> download('phnfield.fgb', new Blob([flatgeobuf.geojson.serialize(Draw.getAll())],{type:'application/octet-stream'}));
  $('btn-clear').onclick        = ()=>{ if(confirm('全て削除しますか？')){ Draw.deleteAll(); refreshStyle(); syncToY(); } };
  $('btn-toggle-labels').onclick= ()=>{ showLabels=!showLabels; updateLabels(); };
  $('btn-toggle-basemap').onclick=()=>{
    basemap=(basemap==='GSI')?'OSM':(basemap==='OSM')?'PHOTO':'GSI';
    map.setLayoutProperty('basemap-gsi','visibility',basemap==='GSI'?'visible':'none');
    map.setLayoutProperty('basemap-osm','visibility',basemap==='OSM'?'visible':'none');
    map.setLayoutProperty('basemap-photo','visibility',basemap==='PHOTO'?'visible':'none');
  };

  // 初期表示
  ensureRoom();
  setStatus(typeof ywebrtc!=='undefined' ? `リアルタイム同期（room=${(new URL(location.href)).searchParams.get('room')}）` : 'ローカル編集（同期なし）');
})();
</script>
</body>
</html>
