<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhnField</title>

<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

<link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet">
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/flatgeobuf/dist/flatgeobuf-geojson.min.js"></script>

<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://unpkg.com/y-webrtc@10.6.9/dist/y-webrtc.min.js"></script>
<script src="https://unpkg.com/y-indexeddb@1.3.9/dist/y-indexeddb.js"></script>

<style>
  html, body { height:100%; margin:0; overflow:hidden; }
  #map { position:absolute; inset:0; }

  /* å·¦ãƒ‘ãƒãƒ«ï¼šå›ºå®šï¼‹ç‹¬ç«‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  .toolbar{
    position:fixed; top:10px; left:10px; z-index:999;
    width:320px; background:#fff; padding:12px; border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.15); font-family:system-ui, sans-serif;
    max-height:calc(100vh - 20px); overflow:auto;
  }
  .toolbar h1{ font-size:16px; margin:0 0 6px; }
  .toolbar .small{ font-size:12px; color:#555; margin:0 0 10px; word-break:break-all; }
  .toolbar button{
    width:100%; margin:6px 0; padding:12px 14px; font-size:16px; min-height:44px;
    border:1px solid #ccc; border-radius:10px; background:#f8f8f8; text-align:left; cursor:pointer;
  }
  .toolbar button.active{ background:#dff0ff; border-color:#2b7fff; }
  .row{ display:flex; gap:10px; align-items:center; margin:6px 0; }
  .row label{ width:110px; font-size:13px; }
  .row input[type="color"]{ width:44px; height:34px; border:none; background:none; padding:0; }
  .row input[type="range"], .row input[type="text"], .row input[type="password"]{ flex:1; padding:8px; }
  .hr{ border-top:1px solid #e6e6e6; margin:10px 0; }

  /* è¦–èªæ€§ã®é«˜ã„ãƒ©ãƒ™ãƒ«ï¼ˆç™½ãƒãƒ­ï¼‰ */
  .comment-label{
    background: transparent; color:#111; font-weight:700; font-size:16px; padding:2px 6px; border-radius:8px;
    text-shadow:
      -2px -2px 0 #fff,  0 -2px 0 #fff,  2px -2px 0 #fff,
      -2px  0   0 #fff,               2px  0   0 #fff,
      -2px  2px 0 #fff,  0  2px 0 #fff,  2px  2px 0 #fff,
      0 0 6px #fff, 0 0 10px #fff;
    pointer-events:none; white-space:nowrap;
  }

  details summary { cursor:pointer; font-weight:600; padding:8px; background:#f2f6ff; border:1px solid #d8e5ff; border-radius:8px; }

  @media (max-width: 768px){
    .toolbar{
      left:0; right:0; top:auto; bottom:0; width:auto;
      border-radius:16px 16px 0 0;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      max-height:48vh; overflow:auto;
    }
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="toolbar">
  <h1>PhnField</h1>
  <div id="status" class="small">èµ·å‹•ä¸­â€¦</div>

  <button id="btn-share">å…±åŒç·¨é›†URLã‚’ã‚³ãƒ”ãƒ¼ï¼ˆroom=20ï¼‰</button>

  <details id="gh-sec" open>
    <summary>GitHubä¿å­˜ï¼ˆæš—å·åŒ–ãƒ»ç®¡ç†è€…ã ã‘æ›¸è¾¼ï¼‰</summary>
    <div class="row"><label>Owner</label><input id="gh-owner" type="text" placeholder="your-name"></div>
    <div class="row"><label>Repo</label><input id="gh-repo" type="text" placeholder="your-repo"></div>
    <div class="row"><label>Branch</label><input id="gh-branch" type="text" value="main"></div>
    <div class="row"><label>ä¿å­˜ãƒ‘ã‚¹</label><input id="gh-path" type="text" readonly></div>
    <div class="row"><label>PATï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</label><input id="gh-token" type="password" placeholder="ghp_...ï¼ˆç«¯æœ«ã«ä¿å­˜ï¼‰"></div>
    <div class="row"><button id="btn-easy">ã‹ã‚“ãŸã‚“è‡ªå‹•ä¿å­˜ã‚’è¨­å®š</button><button id="btn-gh-load">ä¿å­˜å†…å®¹ã‚’èª­ã¿è¾¼ã‚€</button></div>
    <div class="row"><button id="btn-gh-toggle">GitHubã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ï¼šOFF</button></div>
    <div class="small">â€»å…±åŒç·¨é›†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸è¦ã€‚URLã® <b>#k=ï¼ˆç§˜å¯†éµï¼‰</b> ãŒã‚ã‚‹äººã ã‘ä¸­èº«ã‚’é–²è¦§ã§ãã¾ã™ã€‚</div>
  </details>

  <div class="hr"></div>
  <button id="btn-select"  class="active">é¸æŠ/ç§»å‹•</button>
  <button id="btn-point">ç‚¹</button>
  <button id="btn-line">ç·šï¼ˆã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§é ‚ç‚¹ãƒ»ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ç¢ºå®šï¼‰</button>
  <button id="btn-polygon">ãƒãƒªã‚´ãƒ³ï¼ˆåŒä¸Šï¼‰</button>
  <button id="btn-circle">å††ï¼ˆä¸­å¿ƒâ†’ç§»å‹•â†’ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºå®šï¼‰</button>
  <button id="btn-trash">é¸æŠã‚’å‰Šé™¤</button>

  <div class="hr"></div>
  <div class="row"><label>ç·šè‰²</label><input type="color" id="stroke" value="#2b7fff"><input id="strokeW" type="range" min="1" max="10" step="1" value="3"></div>
  <div class="row"><label>é¢è‰²</label><input type="color" id="fill" value="#3b82f6"><input id="fillO" type="range" min="0" max="1" step="0.05" value="0.25"></div>
  <div class="row"><button id="btn-apply-selected">é¸æŠã«é©ç”¨</button><button id="btn-apply-all">å…¨ä½“ã«é©ç”¨</button></div>

  <div class="hr"></div>
  <button id="btn-save-geojson">GeoJSONã§ä¿å­˜</button>
  <button id="btn-save-fgb">FlatGeobufã§ä¿å­˜</button>
  <button id="btn-clear">å…¨å‰Šé™¤</button>
  <button id="btn-toggle-labels">ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º åˆ‡æ›¿</button>
  <button id="btn-toggle-basemap">åœ°å›³åˆ‡æ›¿ï¼ˆGSIâ‡„OSMâ‡„å†™çœŸï¼‰</button>
</div>

<script>
(function(){
  /* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
  const $=(id)=>document.getElementById(id);
  const setStatus=(s)=>{ const el=$('status'); if(el) el.textContent=s; };
  const setActive=(id)=>{ document.querySelectorAll('.toolbar button').forEach(b=>b.classList.remove('active')); $(id)?.classList.add('active'); };

  /* ========= å…±åŒç·¨é›† room=20 ========= */
  const CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
  function randomRoom(n=20){ const a=new Uint32Array(n); crypto.getRandomValues(a); let s=""; for(let i=0;i<n;i++) s+=CHARS[a[i]%CHARS.length]; return s; }
  function ensureRoom(){
    const u=new URL(location.href);
    if(!u.searchParams.get('room')){ u.searchParams.set('room', randomRoom(20)); history.replaceState({},'',u); }
    return u.searchParams.get('room');
  }
  const room=ensureRoom();

  /* ========= #k=ï¼ˆ32ãƒã‚¤ãƒˆã®éµã‚’URLã«ä»˜ä¸ï¼å–å¾—ï¼‰ ========= */
  const b64u = {
    enc:(buf)=>btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''),
    dec:(str)=>Uint8Array.from(atob(str.replace(/-/g,'+').replace(/_/g,'/')),c=>c.charCodeAt(0))
  };
  function getKeyFromHash(){
    const h=new URL(location.href).hash;
    const m=h.match(/(?:^|#|&)k=([A-Za-z0-9\-_]+)/);
    return m? b64u.dec(m[1]) : null;
  }
  async function importKey(raw){ return await crypto.subtle.importKey('raw', raw, 'AES-GCM', false, ['encrypt','decrypt']); }
  async function encryptText(txt, rawKey){
    const key=await importKey(rawKey);
    const iv=crypto.getRandomValues(new Uint8Array(12));
    const ct=await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(txt));
    return JSON.stringify({v:1, iv:b64u.enc(iv), ct:b64u.enc(ct)});
  }
  async function decryptText(payload, rawKey){
    const key=await importKey(rawKey);
    const obj=JSON.parse(payload);
    const iv=b64u.dec(obj.iv), ct=b64u.dec(obj.ct);
    const pt=await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
    return new TextDecoder().decode(pt);
  }
  function ensureKeyInUrl(){
    if(getKeyFromHash()) return;
    const raw=new Uint8Array(32); crypto.getRandomValues(raw);
    const u=new URL(location.href); u.hash='k='+b64u.enc(raw);
    history.replaceState({},'',u);
  }
  ensureKeyInUrl();

  /* ========= å…±æœ‰URLï¼ˆroom + #k= ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼‰ ========= */
  $('btn-share').onclick = async ()=>{
    const u=new URL(location.href);
    try{ await navigator.clipboard.writeText(u.toString()); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼š\n'+u.toString()); }
    catch{ prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', u.toString()); }
  };

  /* ========= åœ°å›³ ========= */
  const map=new maplibregl.Map({
    container:'map',
    style:{
      version:8,
      sources:{
        gsi:{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,
             attribution:"åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆ<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank' rel='noopener'>å‡ºå…¸</a>)"},
        osm:{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,
             attribution:"Â© OpenStreetMap contributors"},
        photo:{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256,
             attribution:"åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆæœ€æ–°å†™çœŸï¼‰"}
      },
      layers:[
        {id:'basemap-gsi',type:'raster',source:'gsi',layout:{visibility:'visible'}},
        {id:'basemap-osm',type:'raster',source:'osm',layout:{visibility:'none'}},
        {id:'basemap-photo',type:'raster',source:'photo',layout:{visibility:'none'}}
      ]
    },
    center:[135.8049,34.6851],zoom:12,attributionControl:true
  });
  map.addControl(new maplibregl.NavigationControl(),'top-right');
  map.addControl(new maplibregl.AttributionControl({compact:false}), 'bottom-right');
  let baseIdx=0; const bases=['basemap-gsi','basemap-osm','basemap-photo'];
  $('btn-toggle-basemap').onclick=()=>{
    baseIdx=(baseIdx+1)%3;
    bases.forEach((id,i)=> map.setLayoutProperty(id,'visibility', i===baseIdx?'visible':'none'));
  };

  /* ========= Drawï¼ˆæ—¢å®šã‚¹ã‚¿ã‚¤ãƒ«ï¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºå®Ÿã«å¯è¦–ï¼‰ ========= */
  const Draw=new MapboxDraw({ displayControlsDefault:false, defaultMode:'simple_select' });
  map.addControl(Draw,'top-left');

  /* ========= ãƒ”ãƒ³ç”»åƒ ========= */
  function addImages(){
    if(!map.hasImage('phn-pin')){
      const svg=`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path fill='#E52525' d='M32 2C20.4 2 11 11.4 11 23c0 14.5 21 39 21 39s21-24.5 21-39C53 11.4 43.6 2 32 2z'/><circle cx='32' cy='23' r='9' fill='#fff'/></svg>`;
      const img=new Image(); img.onload=()=>map.addImage('phn-pin',img,{pixelRatio:2}); img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg);
    }
  }

  /* ========= å®Œæˆå›³å½¢ï¼ˆç™½ãƒãƒ­ï¼‰ï¼‹ç‚¹ã‚¯ãƒ©ã‚¹ã‚¿ ========= */
  function moveUnderDraw(ids){
    const layers=map.getStyle().layers||[]; let lastDraw=null;
    for(const l of layers){ if(l.id.startsWith('gl-draw-')) lastDraw=l.id; }
    if(!lastDraw) return;
    ids.forEach(id=>{ if(map.getLayer(id)) map.moveLayer(id, lastDraw); });
  }

  map.on('load', ()=>{
    addImages();

    map.addSource('phn-style',{type:'geojson', data:{type:'FeatureCollection',features:[]}});

    map.addLayer({id:'phn-fill',type:'fill',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'fill-color':['coalesce',['get','fill'],'#3b82f6'],'fill-opacity':['coalesce',['get','fill-opacity'],0.25]}});
    map.addLayer({id:'phn-outline-casing',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'line-color':'#fff','line-width':['+', ['coalesce',['get','stroke-width'],3], 4],'line-cap':'round','line-join':'round'}});
    map.addLayer({id:'phn-outline',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3],'line-cap':'round','line-join':'round'}});

    map.addLayer({id:'phn-line-casing',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'LineString'],
      paint:{'line-color':'#fff','line-width':['+', ['coalesce',['get','stroke-width'],3], 4],'line-cap':'round','line-join':'round'}});
    map.addLayer({id:'phn-line',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'LineString'],
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3],'line-cap':'round','line-join':'round'}});

    map.addSource('phn-points',{ type:'geojson', data:{type:'FeatureCollection',features:[]}, cluster:true, clusterRadius:40, clusterMaxZoom:14 });
    map.addLayer({id:'phn-clusters', type:'circle', source:'phn-points', filter:['has','point_count'],
      paint:{ 'circle-color':['step',['get','point_count'],'#8ab4ff',10,'#4a90e2',50,'#2b7fff'],
              'circle-radius':['step',['get','point_count'],16,10,20,50,24] }});
    map.addLayer({id:'phn-cluster-count', type:'symbol', source:'phn-points', filter:['has','point_count'],
      layout:{'text-field':['get','point_count_abbreviated'],'text-font':['Open Sans Bold','Arial Unicode MS Bold'],'text-size':14},
      paint:{'text-color':'#111','text-halo-color':'#fff','text-halo-width':3,'text-halo-blur':0.5}});
    map.addLayer({id:'phn-points-unclustered', type:'symbol', source:'phn-points', filter:['!',['has','point_count']],
      layout:{'icon-image':'phn-pin','icon-size':0.9,'icon-allow-overlap':true,'icon-anchor':'bottom'}});

    // å††ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã“ã“ã§å¿…ãšä½œã£ã¦ãŠãï¼‰
    map.addSource('circle-preview',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:'circle-preview-line-casing',type:'line',source:'circle-preview',paint:{'line-color':'#fff','line-width':7,'line-dasharray':[2,1]}});
    map.addLayer({id:'circle-preview-line',type:'line',source:'circle-preview',paint:{'line-color':'#1e90ff','line-width':3,'line-dasharray':[2,1]}});
    map.addLayer({id:'circle-preview-fill',type:'fill',source:'circle-preview',paint:{'fill-color':'#1e90ff','fill-opacity':0.2}});

    moveUnderDraw(['phn-fill','phn-outline-casing','phn-outline','phn-line-casing','phn-line','phn-points-unclustered','phn-clusters','phn-cluster-count','circle-preview-line-casing','circle-preview-line','circle-preview-fill']);
  });
  map.on('styledata', ()=>moveUnderDraw(['phn-fill','phn-outline-casing','phn-outline','phn-line-casing','phn-line','phn-points-unclustered','phn-clusters','phn-cluster-count','circle-preview-line-casing','circle-preview-line','circle-preview-fill']));

  /* ========= ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆYjsï¼‰ ========= */
  let ydoc=null, provider=null, yfeatures=null, realtime=false;
  try{
    ydoc=new Y.Doc();
    new window.yIndexeddb.IndexeddbPersistence('phnfield-'+room, ydoc);
    provider=new ywebrtc.WebrtcProvider('phnfield-'+room, ydoc, {signaling:['wss://signaling.yjs.dev']});
    yfeatures=ydoc.getArray('features');
    yfeatures.observe(()=>{ const arr=yfeatures.toArray(); Draw.deleteAll(); if(arr.length) Draw.add({type:'FeatureCollection',features:arr}); refresh(); });
    realtime=true; setStatus('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼šæ¥ç¶šä¸­ï¼ˆroom='+room+'ï¼‰');
    provider.on('status', e=> setStatus('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼š'+e.status+'ï¼ˆroom='+room+'ï¼‰'));
  }catch{ setStatus('ãƒ­ãƒ¼ã‚«ãƒ«ç·¨é›†ï¼ˆåŒæœŸãªã—ï¼‰'); }
  const syncToY=()=>{ if(!realtime) return; const a=Draw.getAll().features; ydoc.transact(()=>{ yfeatures.delete(0,yfeatures.length); yfeatures.push(a); }); };

  /* ========= ãƒ©ãƒ™ãƒ« ========= */
  const PIN_OFFSET_Y=56;
  const labelCache=new Map(); let showLabels=true;
  function updateLabels(){
    const current=new Set();
    Draw.getAll().features.forEach(f=>{
      const id=f.id, c=f.properties?.comment||''; if(!c){ if(labelCache.has(id)){labelCache.get(id).remove(); labelCache.delete(id);} return; }
      current.add(id);
      let lnglat=null, offset=[0,0];
      if(f.geometry.type==='Point'){ lnglat=f.geometry.coordinates; offset=[0, -(PIN_OFFSET_Y+10)]; }
      else if(f.geometry.type==='LineString'){ lnglat=f.geometry.coordinates[0]; }
      else if(f.geometry.type==='Polygon'){ lnglat=f.geometry.coordinates[0][0]; }
      if(!labelCache.has(id)){
        const el=document.createElement('div'); el.className='comment-label'; el.textContent=c;
        const m=new maplibregl.Marker({element:el, offset}).setLngLat(lnglat).addTo(map);
        labelCache.set(id,m);
      }else{
        const m=labelCache.get(id); m.setLngLat(lnglat); if(m.setOffset) m.setOffset(offset); m.getElement().textContent=c;
      }
    });
    for(const [id,m] of labelCache){ if(!current.has(id)){ m.remove(); labelCache.delete(id);} }
  }

  function refresh(){
    const all=Draw.getAll();
    const linesPolys=all.features.filter(f=>f.geometry.type!=='Point');
    const points=all.features.filter(f=>f.geometry.type==='Point');
    map.getSource('phn-style')?.setData({type:'FeatureCollection',features:linesPolys});
    map.getSource('phn-points')?.setData({type:'FeatureCollection',features:points});
    updateLabels(); scheduleSave(); // GitHubã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ç”¨
  }

  /* ========= å††ãƒ¢ãƒ¼ãƒ‰ï¼ˆåå¿œã—ãªã„ä¸å…·åˆã®ä¿®æ­£ï¼šç¢ºå®Ÿã«æœ‰åŠ¹åŒ–ï¼‰ ========= */
  let circleMode=false, circleCenter=null;
  function exitCircle(){ circleMode=false; circleCenter=null; map.getSource('circle-preview')?.setData({type:'FeatureCollection',features:[]}); map.getCanvas().style.cursor=''; }
  function circlePreview(center, ll){
    if(!center||!ll) return;
    const r=turf.distance(turf.point(center), turf.point([ll.lng,ll.lat]), {units:'kilometers'})*1000;
    const poly=turf.circle(center, Math.max(r,1), {steps:64, units:'meters'});
    map.getSource('circle-preview')?.setData(poly);
  }
  map.on('mousemove', e=>{ if(circleMode && circleCenter) circlePreview(circleCenter, e.lngLat); });
  map.on('click', e=>{
    if(!circleMode) return;
    if(!circleCenter){ circleCenter=[e.lngLat.lng,e.lngLat.lat]; circlePreview(circleCenter,e.lngLat); }
    else{
      const r=turf.distance(turf.point(circleCenter),turf.point([e.lngLat.lng,e.lngLat.lat]),{units:'kilometers'})*1000;
      const poly=turf.circle(circleCenter, Math.max(r,1), {steps:64, units:'meters'});
      const id=Draw.add({type:'Feature', geometry:poly.geometry, properties:{shape:'circle', radius_m:Math.round(r)}});
      exitCircle(); finishWithComment(id);
    }
  });

  /* ========= UIï¼ˆçŸ¢å°é–¢é€£ã¯å®Œå…¨å‰Šé™¤ï¼‰ ========= */
  $('btn-select').onclick = ()=>{ Draw.changeMode('simple_select'); setActive('btn-select'); exitCircle(); map.dragPan.enable(); map.doubleClickZoom.enable(); };
  $('btn-point').onclick  = ()=>{ Draw.changeMode('draw_point');   setActive('btn-point');  exitCircle(); map.dragPan.enable(); map.doubleClickZoom.enable(); };
  $('btn-line').onclick   = ()=>{ Draw.changeMode('draw_line_string'); setActive('btn-line');  exitCircle(); map.dragPan.disable(); map.doubleClickZoom.disable(); };
  $('btn-polygon').onclick= ()=>{ Draw.changeMode('draw_polygon');     setActive('btn-polygon'); exitCircle(); map.dragPan.disable(); map.doubleClickZoom.disable(); };
  $('btn-circle').onclick = ()=>{ circleMode=true; circleCenter=null; setActive('btn-circle'); Draw.changeMode('simple_select'); map.dragPan.enable(); map.doubleClickZoom.enable(); map.getCanvas().style.cursor='crosshair'; };
  $('btn-trash').onclick  = ()=>{ Draw.trash(); refresh(); syncToY(); };

  map.on('draw.modechange', e=>{
    const m=e.mode;
    (m==='draw_line_string'||m==='draw_polygon')? (map.dragPan.disable(), map.doubleClickZoom.disable())
                                                : (map.dragPan.enable(), map.doubleClickZoom.enable());
    moveUnderDraw(['phn-fill','phn-outline-casing','phn-outline','phn-line-casing','phn-line','phn-points-unclustered','phn-clusters','phn-cluster-count','circle-preview-line-casing','circle-preview-line','circle-preview-fill']);
  });

  function finishWithComment(id){
    requestAnimationFrame(()=>{
      const c=prompt('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰') ?? '';
      Draw.setFeatureProperty(id,'comment',c);
      refresh(); syncToY();
      setTimeout(()=>{ Draw.changeMode('simple_select'); setActive('btn-select'); map.dragPan.enable(); map.doubleClickZoom.enable(); },0);
    });
  }
  map.on('draw.create', e=>{ finishWithComment(e.features[0].id); });
  map.on('draw.update', ()=>{ refresh(); syncToY(); });
  map.on('draw.delete', ()=>{ refresh(); syncToY(); });

  /* ========= ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ ========= */
  function applyStyle(feats){
    const s=$('stroke').value, w=+$('strokeW').value, f=$('fill').value, o=parseFloat($('fillO').value);
    feats.forEach(ft=>{
      Draw.setFeatureProperty(ft.id,'stroke',s);
      Draw.setFeatureProperty(ft.id,'stroke-width',w);
      if(ft.geometry.type==='Polygon'){ Draw.setFeatureProperty(ft.id,'fill',f); Draw.setFeatureProperty(ft.id,'fill-opacity',o); }
    });
    refresh(); syncToY();
  }
  $('btn-apply-selected').onclick=()=>{ const sel=Draw.getSelected().features; if(!sel.length){alert('å›³å½¢ã‚’é¸æŠã—ã¦ãã ã•ã„');return;} applyStyle(sel); };
  $('btn-apply-all').onclick = ()=> applyStyle(Draw.getAll().features);

  /* ========= ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ ========= */
  function ts(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }
  function download(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
  $('btn-save-geojson').onclick=()=>{ const fc=Draw.getAll(); download(`PhnField_${ts()}.geojson`, new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'})); };
  $('btn-save-fgb').onclick=()=>{ try{ const fc=Draw.getAll(); const bytes=flatgeobuf.geojson.serialize(fc); download(`PhnField_${ts()}.fgb`, new Blob([bytes], {type:'application/octet-stream'})); }catch(e){ console.error(e); alert('FlatGeobufã®å‡ºåŠ›ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'); } };

  $('btn-clear').onclick=()=>{ if(confirm('å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ Draw.deleteAll(); refresh(); syncToY(); } };
  $('btn-toggle-labels').onclick=()=>{ showLabels=!showLabels; for(const [,mk] of labelCache){ mk.getElement().style.display=showLabels?'':'none'; } if(showLabels) updateLabels(); };

  /* ========= GitHub æš—å·åŒ–ä¿å­˜ï¼ˆç®¡ç†è€…ã ã‘æ›¸è¾¼ï¼‰ ========= */
  const ghOwner=$('gh-owner'), ghRepo=$('gh-repo'), ghBranch=$('gh-branch'), ghPath=$('gh-path'), ghToken=$('gh-token');
  ghPath.value = `phnfield/${room}.bin`; // æ—¢å®šã®ä¿å­˜å…ˆ
  const LSKEY='phnfield-gh';

  function loadGhSettings(){
    try{
      const s=JSON.parse(localStorage.getItem(LSKEY)||'null');
      if(!s) return;
      ghOwner.value=s.owner||''; ghRepo.value=s.repo||''; ghBranch.value=s.branch||'main'; ghPath.value=s.path||`phnfield/${room}.bin`; ghToken.value=s.token||'';
      if(s.auto) toggleAutosave(true, false);
    }catch{}
  }
  function saveGhSettings(){
    localStorage.setItem(LSKEY, JSON.stringify({
      owner:ghOwner.value.trim(), repo:ghRepo.value.trim(), branch:ghBranch.value.trim(), path:ghPath.value.trim(), token:ghToken.value, auto:isAuto
    }));
  }
  $('gh-sec').addEventListener('toggle', ()=>{ if($('gh-sec').open) loadGhSettings(); });
  loadGhSettings(); // åˆå›

  function ghHeaders(token){ return { 'Authorization': 'Bearer '+token, 'Accept':'application/vnd.github+json', 'Content-Type':'application/json' }; }
  async function ghGetMeta(owner,repo,path,branch){
    const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const r=await fetch(url); if(r.status===404) return null; if(!r.ok) throw new Error('GET meta '+r.status);
    return await r.json();
  }
  async function ghPut(owner,repo,path,branch,token,bytes,msg){
    const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const meta=await ghGetMeta(owner,repo,path,branch).catch(()=>null);
    const body={ message: msg, content: b64u.enc(bytes), branch };
    if(meta && meta.sha) body.sha=meta.sha;
    const r=await fetch(url,{method:'PUT', headers:ghHeaders(token), body:JSON.stringify(body)});
    if(!r.ok) throw new Error('PUT '+r.status+' '+(await r.text()));
    return await r.json();
  }
  async function ghGet(owner,repo,path,branch){
    const meta=await ghGetMeta(owner,repo,path,branch);
    if(!meta) return null;
    const raw=b64u.dec(meta.content.replace(/\n/g,'')); // Uint8Array
    return new TextDecoder().decode(raw);
  }

  async function saveToGitHub(){
    const owner=ghOwner.value.trim(), repo=ghRepo.value.trim(), branch=ghBranch.value.trim(), path=ghPath.value.trim(), token=ghToken.value.trim();
    if(!owner || !repo || !branch || !path || !token){ setStatus('GitHubä¿å­˜ï¼šæœªè¨­å®š'); return; }
    const key=getKeyFromHash(); if(!key){ alert('URLã« #k=ï¼ˆç§˜å¯†éµï¼‰ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const fc=Draw.getAll();
    const payload=await encryptText(JSON.stringify(fc), key);
    await ghPut(owner,repo,path,branch,token,new TextEncoder().encode(payload),`save ${new Date().toISOString()}`);
    setStatus('GitHubä¿å­˜ï¼šå®Œäº†'); saveGhSettings();
  }
  async function loadFromGitHub(){
    const owner=ghOwner.value.trim(), repo=ghRepo.value.trim(), branch=ghBranch.value.trim(), path=ghPath.value.trim();
    if(!owner || !repo || !branch || !path){ alert('Owner/Repo/Branch/Path ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
    const key=getKeyFromHash(); if(!key){ alert('URLã« #k=ï¼ˆç§˜å¯†éµï¼‰ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const payload=await ghGet(owner,repo,path,branch);
    if(!payload){ alert('GitHubã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    const txt=await decryptText(payload, key);
    const fc=JSON.parse(txt);
    Draw.deleteAll(); Draw.add(fc); refresh(); syncToY();
    alert('GitHubã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  }
  $('btn-gh-load').onclick=loadFromGitHub;

  // ã‹ã‚“ãŸã‚“è‡ªå‹•ä¿å­˜ï¼ˆèª¬æ˜ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä»˜ãï¼‰
  $('btn-easy').onclick=async ()=>{
    alert(
`ğŸ” PhnField ã‹ã‚“ãŸã‚“è‡ªå‹•ä¿å­˜ï¼ˆç®¡ç†è€…å‘ã‘ï¼‰

1) GitHub ã§ç©ºã®å…¬é–‹ãƒªãƒã‚’ä½œæˆï¼ˆä¾‹: owner=you, repo=phnfield-dataï¼‰
2) GitHub ã®å€‹äººã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆPATï¼‰ã‚’ä½œæˆ
   - Fine-grained / repo ã¸ã® contents:write æ¨©é™ã®ã¿
3) ã“ã®ç”»é¢ã« Owner / Repo / Branchï¼ˆé€šå¸¸ mainï¼‰ã¨ PAT ã‚’å…¥åŠ›
4) ã€ŒGitHubã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ï¼šONã€ã‚’æŠ¼ã™
ä»¥å¾Œã€ã“ã®ç«¯æœ«ã§ç·¨é›†ã™ã‚‹ã¨è‡ªå‹•ã§æš—å·åŒ–ä¿å­˜ã•ã‚Œã¾ã™ã€‚
å…±æœ‰ç›¸æ‰‹ã¯ URLï¼ˆroom= ã¨ #k= ã‚’å«ã‚€ï¼‰ã‚’é–‹ãã ã‘ã§é–²è¦§å¯èƒ½ãƒ»ç·¨é›†ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼ˆYjsï¼‰ã§è¡Œãˆã¾ã™ã€‚`
    );
    // å¿…è¦ãªã‚‰éµã‚’ä»˜ä¸
    ensureKeyInUrl();
    // è‡ªå‹•ONï¼ˆæ¤œè¨¼ä¿å­˜ã‚‚èµ°ã‚‹ï¼‰
    toggleAutosave(true, true);
  };

  // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ï¼ˆ1ç§’ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  let isAuto=false, saveTimer=null;
  function scheduleSave(){ if(!isAuto) return; clearTimeout(saveTimer); saveTimer=setTimeout(saveToGitHub, 1000); }
  function toggleAutosave(forceOn, doTestSave){
    isAuto = (forceOn===true) ? true : !isAuto;
    $('btn-gh-toggle').textContent = 'GitHubã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ï¼š' + (isAuto?'ON':'OFF');
    saveGhSettings();
    if(isAuto && doTestSave) scheduleSave();
  }
  $('btn-gh-toggle').onclick=()=>toggleAutosave();

  // åˆæœŸï¼š#k= ãŒã‚ã‚Šã€Owner/Repo/PathãŒå…¥ã£ã¦ã„ã‚Œã°ã€Œé–²è¦§è€…ã€ã¯è‡ªå‹•èª­è¾¼
  window.addEventListener('load', async ()=>{
    const key=getKeyFromHash();
    if(key && ghOwner.value && ghRepo.value && ghPath.value){
      try{ await loadFromGitHub(); }catch(e){ /* å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ */ }
    }
  });

  /* ========= è£œåŠ© ========= */
  function ts(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }

  // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  setStatus(`ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒï¼šroom=${room} / GitHubã¯ä»»æ„ï¼ˆæš—å·åŒ–ä¿å­˜ãƒ»é–²è¦§ã¯URLã ã‘ã§OKï¼‰`);
})();
</script>
</body>
</html>
