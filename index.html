<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhnField</title>

<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

<link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet">
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/flatgeobuf/dist/flatgeobuf-geojson.min.js"></script>

<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://unpkg.com/y-webrtc@10.6.9/dist/y-webrtc.min.js"></script>
<script src="https://unpkg.com/y-indexeddb@1.3.9/dist/y-indexeddb.js"></script>

<script src="https://unpkg.com/lz-string@1.4.4/libs/lz-string.min.js"></script>

<style>
  html, body { height:100%; margin:0; overflow:hidden; } /* ページ全体スクロールを止める */
  #map { position:absolute; inset:0; }

  /* ★ パネルは常に fixed・独立スクロール */
  .toolbar{
    position:fixed; top:10px; left:10px; z-index:999;
    width:300px; background:#fff; padding:12px; border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.15); font-family:system-ui, sans-serif;
    -webkit-tap-highlight-color: transparent;
    max-height: calc(100vh - 20px); overflow:auto;  /* ←ここがポイント */
  }
  .toolbar h1{ font-size:16px; margin:0 0 6px; }
  .toolbar .small{ font-size:12px; color:#555; margin:0 0 10px; word-break:break-all; }
  .toolbar button{
    width:100%; margin:6px 0; padding:12px 14px; font-size:16px; min-height:44px;
    border:1px solid #ccc; border-radius:10px; background:#f8f8f8; text-align:left; cursor:pointer;
    touch-action: manipulation;
  }
  .toolbar button:hover{ background:#eee; }
  .toolbar button.active{ background:#dff0ff; border-color:#2b7fff; }
  .row{ display:flex; gap:10px; align-items:center; margin:6px 0; }
  .row label{ width:96px; font-size:13px; }
  .row input[type="color"]{ width:44px; height:34px; border:none; background:none; padding:0; }
  .row input[type="range"]{ flex:1; }
  .hr{ border-top:1px solid #e6e6e6; margin:10px 0; }

  .comment-label{
    background: rgba(255,255,255,0);
    color:#111; border-radius:8px; padding:2px 6px; font-size:16px; line-height:1.35; font-weight:700;
    text-shadow:
      -2px -2px 0 #fff,  0 -2px 0 #fff,  2px -2px 0 #fff,
      -2px  0   0 #fff,               2px  0   0 #fff,
      -2px  2px 0 #fff,  0  2px 0 #fff,  2px  2px 0 #fff,
      0 0 6px #fff, 0 0 10px #fff;
    pointer-events:none; white-space:nowrap;
  }

  @media (max-width: 768px){
    .toolbar{
      left:0; right:0; top:auto; bottom:0; width:auto;
      border-radius:16px 16px 0 0;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      max-height:48vh; overflow:auto;  /* モバイルも独立スクロール */
    }
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="toolbar">
  <h1>PhnField</h1>
  <div id="status" class="small">起動中…</div>

  <button id="btn-share">共同編集URLをコピー（room=20文字／状態埋め込み可）</button>
  <button id="btn-merge">複数URLを統合して読み込み</button>

  <div class="hr"></div>

  <button id="btn-select"  class="active">選択/移動</button>
  <button id="btn-point">点</button>
  <button id="btn-line">線（クリック/タップで頂点・ダブルクリック/ダブルタップで確定）</button>
  <button id="btn-polygon">ポリゴン（同上）</button>
  <button id="btn-arrow">矢印（同上・終点から±30°に枝線）</button>
  <button id="btn-circle">円（中心→移動→クリックで確定）</button>
  <button id="btn-trash">選択を削除</button>

  <div class="hr"></div>
  <div class="row"><label>線色</label><input type="color" id="stroke" value="#2b7fff"><input id="strokeW" type="range" min="1" max="10" step="1" value="3"></div>
  <div class="row"><label>面色</label><input type="color" id="fill" value="#3b82f6"><input id="fillO" type="range" min="0" max="1" step="0.05" value="0.25"></div>
  <div class="row"><button id="btn-apply-selected">選択に適用</button><button id="btn-apply-all">全体に適用</button></div>

  <div class="hr"></div>
  <button id="btn-save-geojson">GeoJSONで保存</button>
  <button id="btn-save-fgb">FlatGeobufで保存</button>
  <button id="btn-clear">全削除</button>
  <button id="btn-toggle-labels">コメント表示 切替</button>
  <button id="btn-toggle-basemap">地図切替（GSI⇄OSM⇄写真）</button>

  <div class="hr"></div>
  <button id="btn-pan-me">現在地へ移動（青ピン設置）</button>
  <button id="btn-add-me">現在地を追加（青ピンの点）</button>
</div>

<script>
(function(){
  const $=(id)=>document.getElementById(id);
  const setStatus=(s)=>{ const el=$('status'); if(el) el.textContent=s; };

  /* ===== Map ===== */
  const map=new maplibregl.Map({
    container:'map',
    style:{
      version:8,
      sources:{
        gsi:{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,
             attribution:"地理院タイル（<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank' rel='noopener'>出典</a>)"},
        osm:{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,
             attribution:"© OpenStreetMap contributors"},
        photo:{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256,
             attribution:"地理院タイル（最新写真）"}
      },
      layers:[
        {id:'basemap-gsi',type:'raster',source:'gsi',layout:{visibility:'visible'}},
        {id:'basemap-osm',type:'raster',source:'osm',layout:{visibility:'none'}},
        {id:'basemap-photo',type:'raster',source:'photo',layout:{visibility:'none'}}
      ]
    },
    center:[135.8049,34.6851],zoom:12,attributionControl:true
  });
  map.addControl(new maplibregl.NavigationControl(),'top-right');
  map.addControl(new maplibregl.AttributionControl({compact:false}), 'bottom-right');

  /* ===== Draw（既定スタイル＝プレビュー確実に可視） ===== */
  const Draw=new MapboxDraw({ displayControlsDefault:false, defaultMode:'simple_select' });
  map.addControl(Draw,'top-left');

  /* ===== 画像（赤/青ピン） ===== */
  function addImages(){
    if(!map.hasImage('phn-pin')){
      const svgRed=`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
        <path fill='#E52525' d='M32 2C20.4 2 11 11.4 11 23c0 14.5 21 39 21 39s21-24.5 21-39C53 11.4 43.6 2 32 2z'/><circle cx='32' cy='23' r='9' fill='#fff'/></svg>`;
      const img=new Image(); img.onload=()=>map.addImage('phn-pin',img,{pixelRatio:2}); img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgRed);
    }
    if(!map.hasImage('phn-pin-blue')){
      const svgBlue=`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
        <path fill='#1E90FF' d='M32 2C20.4 2 11 11.4 11 23c0 14.5 21 39 21 39s21-24.5 21-39C53 11.4 43.6 2 32 2z'/><circle cx='32' cy='23' r='9' fill='#fff'/></svg>`;
      const img=new Image(); img.onload=()=>map.addImage('phn-pin-blue',img,{pixelRatio:2}); img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgBlue);
    }
  }

  /* ===== phn-*（完成表示） + 矢印枝線 + 点クラスタ ===== */
  function moveToTop(id){ if(map.getLayer(id)) map.moveLayer(id); } // 引数なし=最上位へ
  function orderLayers(){
    // phn-* は Draw の直下でOK、矢印だけは最上位
    const layers = map.getStyle().layers||[];
    let lastDraw=null;
    for(const l of layers){ if(l.id.startsWith('gl-draw-')) lastDraw=l.id; }
    const before=lastDraw; if(!before) return;
    ['phn-fill','phn-outline-casing','phn-outline','phn-line-casing','phn-line',
     'phn-points-unclustered','phn-clusters','phn-cluster-count',
     'circle-preview-line-casing','circle-preview-line','circle-preview-fill'
    ].forEach(id=>{ if(map.getLayer(id)) map.moveLayer(id, before); });
    // ★ 矢印は最上位へ（被されないように）
    moveToTop('arrow-heads-casing'); moveToTop('arrow-heads');
  }

  map.on('load', ()=>{
    addImages();

    map.addSource('phn-style',{type:'geojson', data:{type:'FeatureCollection',features:[]}});

    map.addLayer({id:'phn-fill',type:'fill',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'fill-color':['coalesce',['get','fill'],'#3b82f6'],'fill-opacity':['coalesce',['get','fill-opacity'],0.25]}});
    map.addLayer({id:'phn-outline-casing',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'line-color':'#fff','line-width':['+', ['coalesce',['get','stroke-width'],3], 4],'line-cap':'round','line-join':'round'}});
    map.addLayer({id:'phn-outline',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3],'line-cap':'round','line-join':'round'}});

    map.addLayer({id:'phn-line-casing',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'LineString'],
      paint:{'line-color':'#fff','line-width':['+', ['coalesce',['get','stroke-width'],3], 4],'line-cap':'round','line-join':'round'}});
    map.addLayer({id:'phn-line',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'LineString'],
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3],'line-cap':'round','line-join':'round'}});

    map.addSource('phn-points',{ type:'geojson', data:{type:'FeatureCollection',features:[]}, cluster:true, clusterRadius:40, clusterMaxZoom:14 });
    map.addLayer({id:'phn-clusters', type:'circle', source:'phn-points', filter:['has','point_count'],
      paint:{ 'circle-color':['step',['get','point_count'],'#8ab4ff',10,'#4a90e2',50,'#2b7fff'],
              'circle-radius':['step',['get','point_count'],16,10,20,50,24] }});
    map.addLayer({id:'phn-cluster-count', type:'symbol', source:'phn-points', filter:['has','point_count'],
      layout:{'text-field':['get','point_count_abbreviated'],'text-font':['Open Sans Bold','Arial Unicode MS Bold'],'text-size':14},
      paint:{'text-color':'#111','text-halo-color':'#fff','text-halo-width':3,'text-halo-blur':0.5}});
    map.addLayer({id:'phn-points-unclustered', type:'symbol', source:'phn-points', filter:['!',['has','point_count']],
      layout:{'icon-image':['coalesce',['get','icon'],'phn-pin'],'icon-size':0.9,'icon-allow-overlap':true,'icon-anchor':'bottom'}});

    // === 矢印の枝線（終点から±30°） ===
    map.addSource('arrow-heads',{type:'geojson',data:{type:'FeatureCollection',features:[]}}); 
    map.addLayer({id:'arrow-heads-casing',type:'line',source:'arrow-heads',
      paint:{'line-color':'#fff','line-width':['+', ['coalesce',['get','stroke-width'],3], 4],'line-cap':'round','line-join':'round'}});
    map.addLayer({id:'arrow-heads',type:'line',source:'arrow-heads',
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3],'line-cap':'round','line-join':'round'}});

    // 円プレビュー
    map.addSource('circle-preview',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:'circle-preview-line-casing',type:'line',source:'circle-preview',paint:{'line-color':'#fff','line-width':7,'line-dasharray':[2,1]}});
    map.addLayer({id:'circle-preview-line',type:'line',source:'circle-preview',paint:{'line-color':'#1e90ff','line-width':3,'line-dasharray':[2,1]}});
    map.addLayer({id:'circle-preview-fill',type:'fill',source:'circle-preview',paint:{'fill-color':'#1e90ff','fill-opacity':0.2}});

    orderLayers();
  });
  map.on('styledata', orderLayers);

  /* ===== 矢印の計算（長さを自動スケール） ===== */
  const HEAD_ANGLE = 30;   // ±30°
  function headLengthM(a,b){
    const seg = turf.distance(turf.point(a), turf.point(b), {units:'kilometers'})*1000; // 直近辺の長さ[m]
    return Math.max(12, Math.min(seg*0.25, 80)); // 12〜80mの範囲で0.25倍
  }
  function arrowHeadSegmentsForLine(coords){
    if(!coords || coords.length<2) return [];
    const a=coords[coords.length-2], b=coords[coords.length-1];
    const bearing=turf.bearing(turf.point(a), turf.point(b));
    const L=headLengthM(a,b)/1000; // km
    const left  = turf.destination(turf.point(b), L, bearing+180-HEAD_ANGLE, {units:'kilometers'}).geometry.coordinates;
    const right = turf.destination(turf.point(b), L, bearing+180+HEAD_ANGLE, {units:'kilometers'}).geometry.coordinates;
    return [
      {type:'Feature',geometry:{type:'LineString',coordinates:[b,left]}},
      {type:'Feature',geometry:{type:'LineString',coordinates:[b,right]}}
    ];
  }
  function updateArrowHeads(){
    const feats=[];
    Draw.getAll().features.forEach(f=>{
      if(f.geometry.type==='LineString' && f.properties?.arrow===true){
        const segs=arrowHeadSegmentsForLine(f.geometry.coordinates);
        segs.forEach(s=>{
          s.properties={
            stroke: f.properties?.stroke ?? '#2b7fff',
            'stroke-width': f.properties?.['stroke-width'] ?? 3,
            parent: f.id, role: 'arrow-head'
          };
          feats.push(s);
        });
      }
    });
    map.getSource('arrow-heads')?.setData({type:'FeatureCollection',features:feats});
    // ★ 常に最前面へ（隠れ防止）
    moveToTop('arrow-heads-casing'); moveToTop('arrow-heads');
  }

  /* ===== 表示更新 ===== */
  const PIN_OFFSET_Y = 56;
  const labelCache = new Map(); let showLabels=true;
  function updateLabels(){
    const current = new Set();
    Draw.getAll().features.forEach(f=>{
      const id=f.id, c=f.properties?.comment||''; if(!c){ if(labelCache.has(id)){ labelCache.get(id).remove(); labelCache.delete(id);} return; }
      current.add(id);
      let lnglat=null, offset=[0,0];
      if(f.geometry.type==='Point'){ lnglat=f.geometry.coordinates; offset=[0, -(PIN_OFFSET_Y+10)]; }
      else if(f.geometry.type==='LineString'){ lnglat=f.geometry.coordinates[0]; }
      else if(f.geometry.type==='Polygon'){ lnglat=f.geometry.coordinates[0][0]; }
      if(!labelCache.has(id)){
        const el=document.createElement('div'); el.className='comment-label'; el.textContent=c;
        const m=new maplibregl.Marker({element:el, offset}).setLngLat(lnglat).addTo(map);
        labelCache.set(id,m);
      }else{
        const m=labelCache.get(id); m.setLngLat(lnglat); if(m.setOffset) m.setOffset(offset);
        m.getElement().textContent=c;
      }
    });
    for(const [id,m] of labelCache){ if(!current.has(id)){ m.remove(); labelCache.delete(id);} }
  }
  function refreshAll(){
    const all=Draw.getAll();
    const linesPolys=all.features.filter(f=>f.geometry.type!=='Point');
    const points=all.features.filter(f=>f.geometry.type==='Point');
    map.getSource('phn-style')?.setData({type:'FeatureCollection',features:linesPolys});
    map.getSource('phn-points')?.setData({type:'FeatureCollection',features:points});
    updateLabels(); updateArrowHeads();
  }

  /* ===== 操作ボタン ===== */
  let arrowMode=false; let circleMode=false, circleCenter=null;
  $('btn-select').onclick = ()=>{ Draw.changeMode('simple_select'); arrowMode=false; map.dragPan.enable(); map.doubleClickZoom.enable(); };
  $('btn-point').onclick  = ()=>{ Draw.changeMode('draw_point');   arrowMode=false; map.dragPan.enable(); map.doubleClickZoom.enable(); };
  $('btn-line').onclick   = ()=>{ Draw.changeMode('draw_line_string'); arrowMode=false; map.dragPan.disable(); map.doubleClickZoom.disable(); };
  $('btn-polygon').onclick= ()=>{ Draw.changeMode('draw_polygon');     arrowMode=false; map.dragPan.disable(); map.doubleClickZoom.disable(); };
  $('btn-arrow').onclick  = ()=>{ arrowMode=true; Draw.changeMode('draw_line_string'); map.dragPan.disable(); map.doubleClickZoom.disable(); setStatus('矢印：終点が先端、ダブルクリック/ダブルタップで確定'); };
  $('btn-circle').onclick = ()=>{ circleMode=true; circleCenter=null; map.getCanvas().style.cursor='crosshair'; arrowMode=false; map.dragPan.enable(); map.doubleClickZoom.enable(); };
  $('btn-trash').onclick  = ()=>{ Draw.trash(); refreshAll(); syncToY(); };

  map.on('draw.modechange', e=>{
    const m=e.mode;
    (m==='draw_line_string'||m==='draw_polygon')? (map.dragPan.disable(), map.doubleClickZoom.disable()) : (map.dragPan.enable(), map.doubleClickZoom.enable(), arrowMode=false);
    if(m!=='draw_point'&&m!=='draw_line_string'&&m!=='draw_polygon'){ circleMode=false; circleCenter=null; map.getCanvas().style.cursor=''; }
    orderLayers();
  });

  /* ===== Draw イベント ===== */
  function finishWithComment(id){
    requestAnimationFrame(()=>{
      const c=prompt('コメントを入力（任意）') ?? '';
      Draw.setFeatureProperty(id,'comment',c);
      refreshAll(); syncToY();
      setTimeout(()=>{ Draw.changeMode('simple_select'); map.dragPan.enable(); map.doubleClickZoom.enable(); },0);
    });
  }
  map.on('draw.create', e=>{
    const f=e.features[0];
    if(arrowMode && f.geometry.type==='LineString'){ Draw.setFeatureProperty(f.id,'arrow',true); }
    finishWithComment(f.id); arrowMode=false;
  });
  map.on('draw.update', ()=>{ refreshAll(); syncToY(); });
  map.on('draw.delete', ()=>{ refreshAll(); syncToY(); });

  /* ===== 円 ===== */
  function circlePreview(center, ll){
    if(!center||!ll) return;
    const r=turf.distance(turf.point(center), turf.point([ll.lng,ll.lat]), {units:'kilometers'})*1000;
    const poly=turf.circle(center, Math.max(r,1), {steps:64, units:'meters'});
    map.getSource('circle-preview')?.setData(poly);
  }
  map.on('mousemove', e=>{ if(circleMode && circleCenter) circlePreview(circleCenter, e.lngLat); });
  map.on('click', e=>{
    if(!circleMode) return;
    if(!circleCenter){ circleCenter=[e.lngLat.lng,e.lngLat.lat]; circlePreview(circleCenter,e.lngLat); }
    else{
      const r=turf.distance(turf.point(circleCenter),turf.point([e.lngLat.lng,e.lngLat.lat]),{units:'kilometers'})*1000;
      const poly=turf.circle(circleCenter, Math.max(r,1), {steps:64, units:'meters'});
      const id=Draw.add({type:'Feature', geometry:poly.geometry, properties:{shape:'circle', radius_m:Math.round(r)}});
      circleMode=false; circleCenter=null; map.getSource('circle-preview')?.setData({type:'FeatureCollection',features:[]}); map.getCanvas().style.cursor='';
      finishWithComment(id);
    }
  });

  /* ===== 保存等（前回と同様） ===== */
  function withArrowGeometry(fc){
    const out=[];
    fc.features.forEach(f=>{
      out.push(f);
      if(f.geometry?.type==='LineString' && f.properties?.arrow===true){
        const segs=arrowHeadSegmentsForLine(f.geometry.coordinates);
        if(segs.length){
          out.push({...segs[0], properties:{...f.properties, role:'arrow-head-left'}});
          out.push({...segs[1], properties:{...f.properties, role:'arrow-head-right'}});
        }
      }
    });
    return {type:'FeatureCollection', features:out};
  }
  function ts(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`; }
  function download(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
  $('btn-save-geojson').onclick=()=>{ const fc=withArrowGeometry(Draw.getAll()); download(`PhnField_${ts()}.geojson`, new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'})); };
  $('btn-save-fgb').onclick=()=>{ try{ const fc=withArrowGeometry(Draw.getAll()); const bytes=flatgeobuf.geojson.serialize(fc); download(`PhnField_${ts()}.fgb`, new Blob([bytes], {type:'application/octet-stream'})); }catch(e){ console.error(e); alert('FlatGeobufの出力でエラーが発生しました。'); } };

  /* ===== 現在地（青ピン設置/追加） ===== */
  let meMarker=null;
  function getPositionOnce(highAcc=true){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject(new Error('Geolocation未対応'));
      navigator.geolocation.getCurrentPosition(
        pos=>resolve(pos), err=>reject(err),
        { enableHighAccuracy: highAcc, timeout: 10000, maximumAge: 0 }
      );
    });
  }
  $('btn-pan-me').onclick = async ()=>{
    try{
      const p=await getPositionOnce(); const {longitude, latitude, accuracy}=p.coords;
      map.easeTo({center:[longitude,latitude], zoom: Math.max(map.getZoom(), 16)});
      const el=document.createElement('img');
      el.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path fill="#1E90FF" d="M32 2C20.4 2 11 11.4 11 23c0 14.5 21 39 21 39s21-24.5 21-39C53 11.4 43.6 2 32 2z"/><circle cx="32" cy="23" r="9" fill="#fff"/></svg>`);
      el.style.width='36px'; el.style.height='36px';
      if(meMarker) meMarker.remove();
      meMarker = new maplibregl.Marker({element:el, anchor:'bottom'}).setLngLat([longitude,latitude]).addTo(map);
      setStatus(`現在地へ移動（精度±${Math.round(accuracy)}m）`);
    }catch(e){ alert('現在地を取得できませんでした。'); }
  };
  $('btn-add-me').onclick = async ()=>{
    try{
      const p=await getPositionOnce(); const {longitude, latitude}=p.coords;
      const f={type:'Feature', geometry:{type:'Point', coordinates:[longitude,latitude]}, properties:{icon:'phn-pin-blue'}};
      const id=Draw.add(f); finishWithComment(id);
    }catch(e){ alert('現在地を取得できませんでした。'); }
  };

  /* ===== 共有・統合（省略なし） ===== */
  const CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
  function randomRoom(n=20){ const a=new Uint32Array(n); crypto.getRandomValues(a); let s=""; for(let i=0;i<n;i++) s+=CHARS[a[i]%CHARS.length]; return s; }
  function ensureRoom(){
    const u=new URL(location.href);
    if(!u.searchParams.get('room')){ u.searchParams.set('room', randomRoom(20)); history.replaceState({},'',u); }
    return new URL(location.href);
  }
  $('btn-share').onclick = async ()=>{
    const url = ensureRoom();
    const include = confirm('現在の図形もURLに含めますか？（#c= に圧縮埋め込み）');
    if (include) {
      const fc = Draw.getAll();
      const c  = LZString.compressToEncodedURIComponent(JSON.stringify(fc));
      url.hash = 'c=' + c;
    } else { url.hash = ''; }
    try { await navigator.clipboard.writeText(url.toString()); alert('コピーしました：\n' + url.toString()); }
    catch { prompt('このURLをコピーしてください', url.toString()); }
  };
  $('btn-merge').onclick = ()=>{
    const text = prompt('統合したい共同編集URLを複数行で貼り付けてください');
    if (!text) return;
    const urls = text.split(/\s+/).filter(Boolean);
    let merged = {type:'FeatureCollection', features:[]};
    urls.forEach(u=>{
      try{
        const url = new URL(u);
        if (url.hash.startsWith('#c=')) {
          const fc = JSON.parse(LZString.decompressFromEncodedURIComponent(url.hash.slice(3)) || 'null');
          if (fc?.type==='FeatureCollection') merged.features.push(...fc.features);
        }
      }catch(e){ console.warn('URL読み込み失敗', u, e); }
    });
    if (merged.features.length===0) { alert('読み込めるデータが見つかりませんでした'); return; }
    Draw.add(merged); refreshAll(); syncToY(); alert('統合しました（'+merged.features.length+'要素）');
  };

  /* ===== 同期 ===== */
  let ydoc=null, provider=null, yfeatures=null, realtime=false;
  try{
    if(window.ywebrtc && window.Y){
      const room=(new URL(location.href)).searchParams.get('room')||randomRoom(20);
      ydoc=new Y.Doc();
      new window.yIndexeddb.IndexeddbPersistence('phnfield-'+room, ydoc);
      provider=new ywebrtc.WebrtcProvider('phnfield-'+room, ydoc, {signaling:['wss://signaling.yjs.dev']});
      yfeatures=ydoc.getArray('features');
      yfeatures.observe(()=>{ const arr=yfeatures.toArray(); Draw.deleteAll(); if(arr.length) Draw.add({type:'FeatureCollection',features:arr}); refreshAll(); });
      realtime=true; setStatus('リアルタイム同期：接続中（room='+room+'）');
      provider.on('status', e=> setStatus('リアルタイム同期：'+e.status+'（room='+room+'）'));
    } else throw new Error();
  }catch{ setStatus('ローカル編集（同期なし）'); }
  function syncToY(){ if(!realtime) return; const a=Draw.getAll().features; ydoc.transact(()=>{ yfeatures.delete(0,yfeatures.length); yfeatures.push(a); }); }

})();
</script>
</body>
</html>
