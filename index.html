<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhnField</title>

<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

<link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet">
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/flatgeobuf/dist/flatgeobuf-geojson.min.js"></script>

<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://unpkg.com/y-webrtc@10.6.9/dist/y-webrtc.min.js"></script>
<script src="https://unpkg.com/y-indexeddb@1.3.9/dist/y-indexeddb.js"></script>

<!-- URLにスナップショットを圧縮埋め込み -->
<script src="https://unpkg.com/lz-string@1.4.4/libs/lz-string.min.js"></script>

<style>
  html, body { height:100%; margin:0; }
  #map { height: calc(var(--vh, 1vh) * 100); } /* iOSのUI高さ変動に強い100vh */

  .toolbar{
    position:absolute; top:60px; left:10px; z-index:999;
    width:280px; background:#fff; padding:12px; border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.15); font-family:system-ui, sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  .toolbar h1{ font-size:16px; margin:0 0 6px; }
  .toolbar .small{ font-size:12px; color:#555; margin:0 0 10px; word-break:break-all; }
  .toolbar button{
    width:100%; margin:6px 0; padding:12px 14px; font-size:16px; min-height:48px;
    border:1px solid #ccc; border-radius:10px; background:#f8f8f8; text-align:left; cursor:pointer;
    touch-action: manipulation;
  }
  .toolbar button:hover{ background:#eee; }
  .toolbar button.active{ background:#dff0ff; border-color:#2b7fff; }
  .row{ display:flex; gap:10px; align-items:center; margin:6px 0; }
  .row label{ width:86px; font-size:13px; }
  .row input[type="color"]{ width:44px; height:34px; border:none; background:none; padding:0; }
  .row input[type="range"]{ flex:1; }
  .hr{ border-top:1px solid #e6e6e6; margin:10px 0; }
  .comment-label{
    background: rgba(0,0,0,0.85); color:#fff; border-radius:8px; padding:6px 8px; font-size:13px;
    box-shadow:0 1px 6px rgba(0,0,0,.25); pointer-events:none; max-width:240px; line-height:1.35;
  }

  /* モバイル描画アクション（確定／戻る） */
  .mobile-draw-actions{
    position: absolute; left:50%; transform: translateX(-50%);
    bottom: calc(96px + env(safe-area-inset-bottom)); z-index:1000;
    display:none; gap:10px;
  }
  .mobile-draw-actions.show{ display:flex; }
  .mobile-draw-actions button{
    border:none; border-radius:14px; padding:12px 16px; font-size:15px;
    box-shadow:0 2px 8px rgba(0,0,0,.2); background:#2b7fff; color:#fff;
  }
  .mobile-draw-actions button.secondary{ background:#666; }

  /* ===== スマホ最適化（768px以下） ===== */
  @media (max-width: 768px){
    .toolbar{
      top:auto; bottom:0; left:0; right:0; width:auto;
      border-radius:16px 16px 0 0;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      max-height:48vh; overflow:auto;
      margin:0; transform: translateY(0); transition: transform .25s ease;
    }
    .toolbar.collapsed{ transform: translateY(calc(100% - 58px)); }
    .toolbar-toggle{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: calc(48vh + 8px);
      z-index:1000; border:none; border-radius:20px; padding:10px 14px; font-size:15px;
      background:#2b7fff; color:#fff; box-shadow:0 2px 10px rgba(0,0,0,.2);
      touch-action: manipulation;
    }
    .toolbar.collapsed + .toolbar-toggle{ bottom: calc(58px + 8px); }
    .toolbar button{ margin:5px 0; min-height:50px; }
    .row label{ width:90px; }
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="toolbar">
  <h1>PhnField</h1>
  <div id="status" class="small">起動中…</div>

  <button id="btn-share">共同編集URLをコピー（room=20文字／状態埋め込み可）</button>
  <button id="btn-merge">複数URLを統合して読み込み</button>

  <div class="hr"></div>

  <button id="btn-select"  class="active">選択/移動</button>
  <button id="btn-point">点</button>
  <button id="btn-line">線（PC:ダブルクリック確定／スマホ:タップ→確定）</button>
  <button id="btn-polygon">ポリゴン（同上）</button>
  <button id="btn-arrow">矢印（同上）</button>
  <button id="btn-circle">円（中心→移動→クリックで確定）</button>
  <button id="btn-trash">選択を削除</button>

  <div class="hr"></div>
  <div class="row"><label>線色</label><input type="color" id="stroke" value="#2b7fff"><input id="strokeW" type="range" min="1" max="10" step="1" value="3"></div>
  <div class="row"><label>面色</label><input type="color" id="fill" value="#3b82f6"><input id="fillO" type="range" min="0" max="1" step="0.05" value="0.25"></div>
  <div class="row"><button id="btn-apply-selected">選択に適用</button><button id="btn-apply-all">全体に適用</button></div>

  <div class="hr"></div>
  <button id="btn-save-geojson">GeoJSONで保存</button>
  <button id="btn-save-fgb">FlatGeobufで保存</button>
  <button id="btn-clear">全削除</button>
  <button id="btn-toggle-labels">コメント表示 切替</button>
  <button id="btn-toggle-basemap">地図切替（GSI⇄OSM⇄写真）</button>
</div>

<!-- モバイル：ボトムシート開閉 -->
<button id="toolbar-toggle" class="toolbar-toggle" aria-expanded="true">▼ ツールを閉じる</button>

<!-- モバイル：作図アクション -->
<div id="mobile-actions" class="mobile-draw-actions">
  <button id="btn-mobile-undo" class="secondary">1点戻る</button>
  <button id="btn-mobile-finish">確定</button>
</div>

<script>
(function(){
  /* ===== 100vh安定化（iOS対策）／ボトムシート開閉 ===== */
  function setVh(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
  setVh(); window.addEventListener('resize', setVh);
  const tb = document.querySelector('.toolbar');
  const tgl = document.getElementById('toolbar-toggle');
  function applyMobileSheet(){
    const isMobile = window.matchMedia('(max-width:768px)').matches;
    if(!isMobile){
      tb.classList.remove('collapsed');
      if (tgl){ tgl.style.display='none'; tgl.setAttribute('aria-expanded','true'); tgl.textContent=''; }
    }else{
      if (tgl){ tgl.style.display='block'; }
      if (!tb.dataset.inited){
        tb.classList.add('collapsed'); // 初回は折りたたみ
        if (tgl){ tgl.setAttribute('aria-expanded','false'); tgl.textContent='▲ ツールを開く'; }
        tb.dataset.inited = '1';
      }
    }
  }
  applyMobileSheet();
  window.matchMedia('(max-width:768px)').addEventListener('change', applyMobileSheet);
  if (tgl){
    tgl.addEventListener('click', ()=>{
      tb.classList.toggle('collapsed');
      const expanded = !tb.classList.contains('collapsed');
      tgl.setAttribute('aria-expanded', String(expanded));
      tgl.textContent = expanded ? '▼ ツールを閉じる' : '▲ ツールを開く';
    });
  }

  /* ===== 便利関数 ===== */
  const $=(id)=>document.getElementById(id);
  const setStatus=(s)=>{ const el=$('status'); if(el) el.textContent=s; };
  const setActive=(id)=>{ document.querySelectorAll('.toolbar button').forEach(b=>b.classList.remove('active')); $(id)?.classList.add('active'); };

  /* ===== room=20文字（URL安全：A–Z a–z 0–9 - _） ===== */
  const CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
  function randomRoom(n=20){ const a=new Uint32Array(n); crypto.getRandomValues(a); let s=""; for(let i=0;i<n;i++) s+=CHARS[a[i]%CHARS.length]; return s; }
  function ensureRoom(){
    const u=new URL(location.href);
    if(!u.searchParams.get('room')){ u.searchParams.set('room', randomRoom(20)); history.replaceState({},'',u); }
    return new URL(location.href);
  }

  /* ===== 共有URL ===== */
  $('btn-share').onclick = async ()=>{
    const url = ensureRoom();
    const include = confirm('現在の図形もURLに含めますか？（#c= に圧縮埋め込み）');
    if (include) {
      const fc = Draw.getAll();
      const c  = LZString.compressToEncodedURIComponent(JSON.stringify(fc));
      url.hash = 'c=' + c;
    } else {
      url.hash = '';
    }
    const s = url.toString();
    try { await navigator.clipboard.writeText(s); alert('コピーしました：\n' + s); }
    catch { prompt('このURLをコピーしてください', s); }
  };
  $('btn-merge').onclick = ()=>{
    const text = prompt('統合したい共同編集URLを複数行で貼り付けてください');
    if (!text) return;
    const urls = text.split(/\s+/).filter(Boolean);
    let merged = {type:'FeatureCollection', features:[]};
    urls.forEach(u=>{
      try{
        const url = new URL(u);
        if (url.hash.startsWith('#c=')) {
          const fc = JSON.parse(LZString.decompressFromEncodedURIComponent(url.hash.slice(3)) || 'null');
          if (fc?.type==='FeatureCollection') merged.features.push(...fc.features);
        }
      }catch(e){ console.warn('URL読み込み失敗', u, e); }
    });
    if (merged.features.length===0) { alert('読み込めるデータが見つかりませんでした'); return; }
    Draw.add(merged); refreshStyle(); syncDebounced();
    alert('統合しました（'+merged.features.length+'要素）');
  };

  const roomName=(new URL(location.href)).searchParams.get('room')||randomRoom(20);

  /* ===== Basemap ===== */
  const map=new maplibregl.Map({
    container:'map',
    style:{
      version:8,
      sources:{
        gsi:{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,
             attribution:"地理院タイル（<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank' rel='noopener'>出典</a>)"},
        osm:{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,
             attribution:"© OpenStreetMap contributors"},
        photo:{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256,
             attribution:"地理院タイル（全国最新写真）"}
      },
      layers:[
        {id:'basemap-gsi',type:'raster',source:'gsi',layout:{visibility:'visible'}},
        {id:'basemap-osm',type:'raster',source:'osm',layout:{visibility:'none'}},
        {id:'basemap-photo',type:'raster',source:'photo',layout:{visibility:'none'}}
      ]
    },
    center:[135.8049,34.6851],zoom:12,attributionControl:true
  });
  map.addControl(new maplibregl.NavigationControl(),'top-right');
  map.addControl(new maplibregl.AttributionControl({compact:false}), 'bottom-right');
  let basemap='GSI';

  /* ===== Draw（プレビュー＝破線／inactiveは透明で選択ヒット） ===== */
  const drawStyles=[
    { id:'gl-draw-line-active', type:'line',
      filter:['all',['==','active','true'],['==',['geometry-type'],'LineString']],
      paint:{
        'line-color':'#2b7fff',
        'line-width':['interpolate',['linear'],['zoom'],9,2,14,4,18,6],
        'line-dasharray':[2,2],
        'line-cap':'round','line-join':'round'
      } },
    { id:'gl-draw-polygon-stroke-active', type:'line',
      filter:['all',['==','active','true'],['==',['geometry-type'],'Polygon']],
      paint:{
        'line-color':'#2b7fff',
        'line-width':['interpolate',['linear'],['zoom'],9,2,14,3,18,5],
        'line-dasharray':[2,2],
        'line-cap':'round','line-join':'round'
      } },
    { id:'gl-draw-polygon-fill-active', type:'fill',
      filter:['all',['==','active','true'],['==',['geometry-type'],'Polygon']],
      paint:{'fill-color':'#66aaff','fill-opacity':0.15} },
    { id:'gl-draw-vertex-halo-active', type:'circle',
      filter:['all',['==','meta','vertex'],['==','active','true']],
      paint:{'circle-radius':6,'circle-color':'#fff'} },
    { id:'gl-draw-vertex-active', type:'circle',
      filter:['all',['==','meta','vertex'],['==','active','true']],
      paint:{'circle-radius':3,'circle-color':'#2b7fff'} },
    // inactive：見えないが当たり判定は太めに残す
    { id:'gl-draw-line-inactive', type:'line',
      filter:['all',['==','active','false'],['==',['geometry-type'],'LineString']],
      paint:{'line-color':'#000','line-opacity':0.001,'line-width':10} },
    { id:'gl-draw-polygon-stroke-inactive', type:'line',
      filter:['all',['==','active','false'],['==',['geometry-type'],'Polygon']],
      paint:{'line-color':'#000','line-opacity':0.001,'line-width':10} },
    { id:'gl-draw-polygon-fill-inactive', type:'fill',
      filter:['all',['==','active','false'],['==',['geometry-type'],'Polygon']],
      paint:{'fill-color':'#000','fill-opacity':0.001} },
    { id:'gl-draw-point-inactive', type:'circle',
      filter:['all',['==','active','false'],['==',['geometry-type'],'Point']],
      paint:{'circle-color':'#000','circle-opacity':0.001,'circle-radius':8} },
    { id:'gl-draw-point-active', type:'circle',
      filter:['all',['==','active','true'],['==',['geometry-type'],'Point']],
      paint:{'circle-opacity':0} }
  ];
  const Draw=new MapboxDraw({displayControlsDefault:false, defaultMode:'simple_select', styles:drawStyles});
  map.addControl(Draw,'top-left');

  /* ===== 自前レイヤ（完成図／点クラスタ／矢印ヘッド）＋プレビュー（円・モバイル線/面） ===== */
  function addImages(){
    if(!map.hasImage('phn-pin')){
      const svgPin=`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
        <path fill='#E52525' d='M32 2C20.4 2 11 11.4 11 23c0 14.5 21 39 21 39s21-24.5 21-39C53 11.4 43.6 2 32 2z'/><circle cx='32' cy='23' r='9' fill='#fff'/></svg>`;
      const img=new Image(); img.onload=()=>map.addImage('phn-pin',img,{pixelRatio:2}); img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgPin);
    }
    if(!map.hasImage('arrow-head')){
      const svgA=`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M32 6 L52 40 L12 40 Z' fill='#111'/></svg>`;
      const img=new Image(); img.onload=()=>map.addImage('arrow-head',img,{pixelRatio:2}); img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svgA);
    }
  }

  function placePhnUnderActive() {
    const activeOrder = [
      'gl-draw-polygon-fill-active',
      'gl-draw-polygon-stroke-active',
      'gl-draw-line-active',
      'gl-draw-vertex-halo-active',
      'gl-draw-vertex-active'
    ];
    const anchor = activeOrder.find(id => map.getLayer(id));
    if (!anchor) return;
    const ids = [
      'phn-fill','phn-outline','phn-line',
      'phn-points-unclustered','phn-clusters','phn-cluster-count',
      'arrow-points-layer',
      'circle-preview-fill','circle-preview-line',
      'temp-line-layer','temp-poly-fill','temp-poly-line'
    ];
    ids.forEach(id=>{ if(map.getLayer(id)) map.moveLayer(id, anchor); });
  }

  map.on('load', ()=>{
    addImages();

    // 完成図（線・面）
    map.addSource('phn-style',{type:'geojson', data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:'phn-fill',type:'fill',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'fill-color':['coalesce',['get','fill'],'#3b82f6'],'fill-opacity':['coalesce',['get','fill-opacity'],0.25]}});
    map.addLayer({id:'phn-outline',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'Polygon'],
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3]}});
    map.addLayer({id:'phn-line',type:'line',source:'phn-style',
      filter:['==',['geometry-type'],'LineString'],
      paint:{'line-color':['coalesce',['get','stroke'],'#2b7fff'],'line-width':['coalesce',['get','stroke-width'],3],'line-cap':'round','line-join':'round'}});

    // 点（クラスタ）
    map.addSource('phn-points',{ type:'geojson', data:{type:'FeatureCollection',features:[]}, cluster:true, clusterRadius:40, clusterMaxZoom:14 });
    map.addLayer({id:'phn-clusters', type:'circle', source:'phn-points', filter:['has','point_count'],
      paint:{ 'circle-color':['step',['get','point_count'],'#8ab4ff',10,'#4a90e2',50,'#2b7fff'],
              'circle-radius':['step',['get','point_count'],14,10,18,50,22] }});
    map.addLayer({id:'phn-cluster-count', type:'symbol', source:'phn-points', filter:['has','point_count'],
      layout:{'text-field':['get','point_count_abbreviated'],'text-font':['Open Sans Bold','Arial Unicode MS Bold'],'text-size':12}});
    map.addLayer({id:'phn-points-unclustered', type:'symbol', source:'phn-points', filter:['!',['has','point_count']],
      layout:{'icon-image':'phn-pin','icon-size':0.9,'icon-allow-overlap':true}});

    // 矢印ヘッド（表示）
    map.addSource('arrow-points',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:'arrow-points-layer',type:'symbol',source:'arrow-points',
      layout:{'icon-image':'arrow-head','icon-size':1.0,'icon-rotation-alignment':'map','icon-rotate':['get','bearing'],'icon-allow-overlap':true}});

    // 円プレビュー
    map.addSource('circle-preview',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:'circle-preview-fill',type:'fill',source:'circle-preview',paint:{'fill-color':'#1e90ff','fill-opacity':0.2}});
    map.addLayer({id:'circle-preview-line',type:'line',source:'circle-preview',paint:{'line-color':'#1e90ff','line-width':3,'line-dasharray':[2,1]}});

    // モバイル用：線／ポリゴンの自前プレビュー
    map.addSource('temp-line',{type:'geojson',data:{type:'FeatureCollection',features:[]}}); // LineString
    map.addLayer({id:'temp-line-layer',type:'line',source:'temp-line',
      paint:{'line-color':'#2b7fff','line-width':['interpolate',['linear'],['zoom'],9,2,14,4,18,6],'line-dasharray':[2,2],'line-cap':'round','line-join':'round'}});
    map.addSource('temp-poly',{type:'geojson',data:{type:'FeatureCollection',features:[]}}); // Polygon
    map.addLayer({id:'temp-poly-fill',type:'fill',source:'temp-poly',paint:{'fill-color':'#66aaff','fill-opacity':0.15}});
    map.addLayer({id:'temp-poly-line',type:'line',source:'temp-poly',paint:{'line-color':'#2b7fff','line-width':['interpolate',['linear'],['zoom'],9,2,14,3,18,5],'line-dasharray':[2,2],'line-cap':'round','line-join':'round'}});

    refreshStyle();
    placePhnUnderActive();

    // 共有URLの #c= 初期復元→Yjsへ流し込み
    const h = new URL(location.href).hash;
    if (h.startsWith('#c=')) {
      try {
        const fc = JSON.parse(LZString.decompressFromEncodedURIComponent(h.slice(3)) || 'null');
        if (fc && fc.type === 'FeatureCollection') {
          Draw.deleteAll(); Draw.add(fc); refreshStyle(); syncDebounced();
        }
      } catch (err) { console.warn('共有データの復元に失敗', err); }
    }
  });
  map.on('styledata', placePhnUnderActive);

  /* ===== P2P + IndexedDB ===== */
  let ydoc=null, provider=null, yfeatures=null, realtime=false;
  try{
    if(window.ywebrtc && window.Y){
      ydoc=new Y.Doc();
      new window.yIndexeddb.IndexeddbPersistence('phnfield-'+roomName, ydoc);
      provider=new ywebrtc.WebrtcProvider('phnfield-'+roomName, ydoc, {signaling:['wss://signaling.yjs.dev']});
      yfeatures=ydoc.getArray('features');
      yfeatures.observe(()=>{ const arr=yfeatures.toArray(); Draw.deleteAll(); if(arr.length) Draw.add({type:'FeatureCollection',features:arr}); refreshDebounced(); });
      realtime=true; setStatus('リアルタイム同期：接続中（room='+roomName+'）');
      provider.on('status', e=> setStatus('リアルタイム同期：'+e.status+'（room='+roomName+'）'));
    } else throw new Error();
  }catch{ setStatus('ローカル編集（同期なし）'); }

  /* ===== デバウンス ===== */
  function makeDebounced(fn, wait=150){ let t=0; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }
  const refreshDebounced = makeDebounced(()=>{ refreshStyle(); }, 80);
  const syncDebounced    = makeDebounced(()=>{ syncToY(); }, 150);
  let raf=0; // 矢印ヘッド更新をrAFでまとめる
  map.on('draw.render', ()=>{ if(raf) cancelAnimationFrame(raf); raf=requestAnimationFrame(()=>{ updateArrowHeads(); raf=0; }); });

  /* ===== ラベル・矢印ヘッド ===== */
  const labelCache = new Map(); // id -> Marker
  let showLabels=true;
  function updateLabels(){
    const currentIds = new Set();
    Draw.getAll().features.forEach(f=>{
      const id=f.id; const c=f.properties?.comment||'';
      if(!c){ if(labelCache.has(id)){ labelCache.get(id).remove(); labelCache.delete(id); } return; }
      currentIds.add(id);
      let ll=(f.geometry.type==='Point')?f.geometry.coordinates:(f.geometry.type==='LineString')?f.geometry.coordinates[0]:f.geometry.coordinates[0][0];
      if(!labelCache.has(id)){
        const el=document.createElement('div'); el.className='comment-label'; el.textContent=c;
        const m = new maplibregl.Marker({element:el}).setLngLat(ll).addTo(map);
        labelCache.set(id, m);
      }else{
        labelCache.get(id).setLngLat(ll);
        labelCache.get(id).getElement().textContent=c;
      }
    });
    for (const [id, mk] of labelCache){ if(!currentIds.has(id)){ mk.remove(); labelCache.delete(id); } }
  }
  function updateArrowHeads(){
    if(!map.getSource('arrow-points')) return;
    const feats=[];
    Draw.getAll().features.forEach(f=>{
      if(f.geometry.type==='LineString' && f.properties?.arrow===true){
        const cs=f.geometry.coordinates; if(cs.length<2) return;
        const a=cs[cs.length-2], b=cs[cs.length-1];
        const bearing=turf.bearing(turf.point(a), turf.point(b));
        feats.push({type:'Feature',geometry:{type:'Point',coordinates:b},properties:{bearing}});
      }
    });
    map.getSource('arrow-points').setData({type:'FeatureCollection',features:feats});
  }

  /* ===== 表示更新（線・面／点クラスタ） ===== */
  function refreshStyle(){
    const all=Draw.getAll();
    const linesPolys=all.features.filter(f=>f.geometry.type!=='Point');
    const points=all.features.filter(f=>f.geometry.type==='Point');
    map.getSource('phn-style')?.setData({type:'FeatureCollection',features:linesPolys});
    map.getSource('phn-points')?.setData({type:'FeatureCollection',features:points});
    updateLabels(); updateArrowHeads();
  }

  /* ===== 円モード ===== */
  let circleMode=false, circleCenter=null;
  function exitCircle(){ circleMode=false; circleCenter=null; map.getSource('circle-preview')?.setData({type:'FeatureCollection',features:[]}); map.getCanvas().style.cursor=''; }
  function circlePreview(center, ll){
    if(!center||!ll) return;
    const r=turf.distance(turf.point(center), turf.point([ll.lng,ll.lat]), {units:'kilometers'})*1000;
    const poly=turf.circle(center, Math.max(r,1), {steps:64, units:'meters'});
    map.getSource('circle-preview').setData(poly);
  }
  map.on('mousemove', e=>{ if(circleMode && circleCenter) circlePreview(circleCenter, e.lngLat); });
  map.on('touchmove', e=>{ if(circleMode && circleCenter){ const t=e.originalEvent.touches?.[0]; if(t) circlePreview(circleCenter, map.unproject([t.clientX,t.clientY])); }});
  map.on('click', e=>{
    if(!circleMode) return;
    if(!circleCenter){ circleCenter=[e.lngLat.lng,e.lngLat.lat]; circlePreview(circleCenter,e.lngLat); }
    else{
      const r=turf.distance(turf.point(circleCenter),turf.point([e.lngLat.lng,e.lngLat.lat]),{units:'kilometers'})*1000;
      const poly=turf.circle(circleCenter, Math.max(r,1), {steps:64, units:'meters'});
      const id=Draw.add({type:'Feature', geometry:poly.geometry, properties:{shape:'circle', radius_m:Math.round(r)}});
      exitCircle(); finishWithComment(id);
    }
  });

  /* ===== モバイル専用：線／ポリゴン／矢印＝タップで頂点追加 ===== */
  const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints>0;
  let customMode=null; // 'line' | 'polygon' | 'arrow'
  let tempCoords=[];
  function showMobileActions(show){ const el=$('mobile-actions'); if(el) el.classList.toggle('show', !!show); }
  function clearTemp(){
    tempCoords=[];
    map.getSource('temp-line')?.setData({type:'FeatureCollection',features:[]});
    map.getSource('temp-poly')?.setData({type:'FeatureCollection',features:[]});
  }
  function updateTempPreview(){
    if(customMode==='line' || customMode==='arrow'){
      const geom = (tempCoords.length>=1)? {type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'LineString',coordinates:tempCoords}}]} : {type:'FeatureCollection',features:[]};
      map.getSource('temp-line').setData(geom);
    }else if(customMode==='polygon'){
      if(tempCoords.length>=2){
        const ring = tempCoords.concat([tempCoords[0]]);
        const fc = {type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Polygon',coordinates:[ring]}}]};
        map.getSource('temp-poly').setData(fc);
      }else{
        map.getSource('temp-poly').setData({type:'FeatureCollection',features:[]});
      }
    }
  }
  function enterCustom(mode){
    customMode=mode; clearTemp(); showMobileActions(true); setStatus('タップで頂点追加 → 「確定」で完了');
    // PCのdrawモードはオフ
    Draw.changeMode('simple_select');
    placePhnUnderActive();
  }
  function exitCustom(){
    customMode=null; clearTemp(); showMobileActions(false);
  }

  map.on('click', (e)=>{
    if(!customMode) return;
    tempCoords.push([e.lngLat.lng,e.lngLat.lat]); updateTempPreview();
  });
  $('btn-mobile-undo').onclick=()=>{ if(!customMode) return; tempCoords.pop(); updateTempPreview(); };
  $('btn-mobile-finish').onclick=()=>{
    if(!customMode) return;
    if((customMode==='line' || customMode==='arrow') && tempCoords.length>=2){
      const props={};
      if(customMode==='arrow') props.arrow=true;
      const id=Draw.add({type:'Feature',geometry:{type:'LineString',coordinates:tempCoords.slice()},properties:props});
      exitCustom(); finishWithComment(id);
    }else if(customMode==='polygon' && tempCoords.length>=3){
      const ring=tempCoords.concat([tempCoords[0]]);
      const id=Draw.add({type:'Feature',geometry:{type:'Polygon',coordinates:[ring]},properties:{}});
      exitCustom(); finishWithComment(id);
    }else{
      alert('頂点が足りません');
    }
  };

  /* ===== ボタン：PCはDraw、スマホはカスタム作図 ===== */
  let arrowMode=false; // PC用
  $('btn-select').onclick = ()=>{ exitCustom(); Draw.changeMode('simple_select'); setActive('btn-select'); exitCircle(); arrowMode=false; };
  $('btn-point').onclick  = ()=>{ exitCustom(); Draw.changeMode('draw_point');   setActive('btn-point');  exitCircle(); arrowMode=false; };
  $('btn-line').onclick   = ()=>{ exitCircle(); arrowMode=false; setActive('btn-line');  isTouch ? enterCustom('line')    : Draw.changeMode('draw_line_string'); };
  $('btn-polygon').onclick= ()=>{ exitCircle(); arrowMode=false; setActive('btn-polygon'); isTouch ? enterCustom('polygon') : Draw.changeMode('draw_polygon'); };
  $('btn-arrow').onclick  = ()=>{ exitCircle(); setActive('btn-arrow'); isTouch ? enterCustom('arrow') : (arrowMode=true, Draw.changeMode('draw_line_string'), setStatus('矢印：線の終点に矢じり')); };
  $('btn-circle').onclick = ()=>{ exitCustom(); circleMode=true; circleCenter=null; map.getCanvas().style.cursor='crosshair'; setActive('btn-circle'); arrowMode=false; };
  $('btn-trash').onclick  = ()=>{ Draw.trash(); refreshDebounced(); syncDebounced(); };

  /* ===== 生成/更新/削除（PC時のDraw） ===== */
  function finishWithComment(id){
    requestAnimationFrame(()=>{
      const c=prompt('コメントを入力（任意）') ?? '';
      Draw.setFeatureProperty(id,'comment',c);
      refreshDebounced(); syncDebounced();
      setTimeout(()=>{ Draw.changeMode('simple_select'); setActive('btn-select'); map.doubleClickZoom.enable(); },0);
    });
  }
  map.on('draw.create', e=>{
    const f=e.features[0];
    if(arrowMode && f.geometry.type==='LineString') Draw.setFeatureProperty(f.id,'arrow',true);
    finishWithComment(f.id); arrowMode=false;
  });
  map.on('draw.update', ()=>{ refreshDebounced(); syncDebounced(); });
  map.on('draw.delete', ()=>{ refreshDebounced(); syncDebounced(); });
  map.on('draw.modechange', e=>{
    const m=e.mode;
    (m==='draw_line_string'||m==='draw_polygon')?map.doubleClickZoom.disable():map.doubleClickZoom.enable();
    if(m!=='draw_point'&&m!=='draw_line_string'&&m!=='draw_polygon'){ exitCircle(); arrowMode=false; setActive('btn-select'); }
    placePhnUnderActive();
  });

  /* ===== スタイル適用 ===== */
  function applyStyle(feats){
    const s=$('stroke').value, w=+$('strokeW').value, f=$('fill').value, o=parseFloat($('fillO').value);
    feats.forEach(ft=>{
      Draw.setFeatureProperty(ft.id,'stroke',s);
      Draw.setFeatureProperty(ft.id,'stroke-width',w);
      if(ft.geometry.type==='Polygon'){ Draw.setFeatureProperty(ft.id,'fill',f); Draw.setFeatureProperty(ft.id,'fill-opacity',o); }
    });
    refreshDebounced(); syncDebounced();
  }
  $('btn-apply-selected').onclick=()=>{ const sel=Draw.getSelected().features; if(!sel.length){alert('図形を選択してください');return;} applyStyle(sel); };
  $('btn-apply-all').onclick = ()=> applyStyle(Draw.getAll().features);

  /* ===== 矢印を実ジオメトリ付きで書き出す（線＋三角Polygon） ===== */
  function arrowHeadPolygonForLine(coords){
    if(coords.length<2) return null;
    const a=coords[coords.length-2], b=coords[coords.length-1];
    const bearing=turf.bearing(turf.point(a), turf.point(b));
    const tip=b; const L=0.015; const theta=25; // 15m・25°
    const left = turf.destination(turf.point(tip), L, bearing+180-theta, {units:'kilometers'}).geometry.coordinates;
    const right= turf.destination(turf.point(tip), L, bearing+180+theta, {units:'kilometers'}).geometry.coordinates;
    return [tip, left, right, tip];
  }
  function withArrowGeometry(fc){
    const out=[];
    fc.features.forEach(f=>{
      out.push(f);
      if(f.geometry?.type==='LineString' && f.properties?.arrow===true){
        const ring=arrowHeadPolygonForLine(f.geometry.coordinates);
        if(ring){
          out.push({
            type:'Feature',
            properties:{...f.properties, role:'arrow-head'},
            geometry:{type:'Polygon', coordinates:[ring]}
          });
        }
      }
    });
    return {type:'FeatureCollection', features:out};
  }

  /* ===== 保存（ファイル名：PhnField_YYYYMMDD_HHMM） ===== */
  function ts(){
    const d=new Date();
    const pad=(n)=>String(n).padStart(2,'0');
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
  }
  function download(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
  $('btn-save-geojson').onclick=()=>{
    const fc=withArrowGeometry(Draw.getAll());
    download(`PhnField_${ts()}.geojson`, new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'}));
  };
  $('btn-save-fgb').onclick=()=>{
    try{
      const fc=withArrowGeometry(Draw.getAll());
      const bytes=flatgeobuf.geojson.serialize(fc);
      download(`PhnField_${ts()}.fgb`, new Blob([bytes], {type:'application/octet-stream'}));
    }catch(e){ console.error(e); alert('FlatGeobufの出力でエラーが発生しました。ブラウザを最新化して再試行してください。'); }
  };

  /* ===== その他 ===== */
  function syncToY(){
    if(!realtime) return;
    const a=Draw.getAll().features;
    ydoc.transact(()=>{ yfeatures.delete(0,yfeatures.length); yfeatures.push(a); });
  }
  $('btn-clear').onclick = ()=>{ if(confirm('全て削除しますか？')){ Draw.deleteAll(); refreshDebounced(); syncDebounced(); } };
  $('btn-toggle-labels').onclick=()=>{ showLabels=!showLabels; for (const [,mk] of labelCache) mk.getElement().style.display = showLabels?'':'none'; if(showLabels) updateLabels(); };
  $('btn-toggle-basemap').onclick=()=>{
    basemap=(basemap==='GSI')?'OSM':(basemap==='OSM')?'PHOTO':'GSI';
    map.setLayoutProperty('basemap-gsi','visibility',basemap==='GSI'?'visible':'none');
    map.setLayoutProperty('basemap-osm','visibility',basemap==='OSM'?'visible':'none');
    map.setLayoutProperty('basemap-photo','visibility',basemap==='PHOTO'?'visible':'none');
  };

  // 初期
  ensureRoom();
  setStatus(typeof ywebrtc!=='undefined' ? `リアルタイム同期（room=${(new URL(location.href)).searchParams.get('room')}）` : 'ローカル編集（同期なし）');
})();
</script>
</body>
</html>
