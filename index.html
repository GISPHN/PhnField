<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhnField</title>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- maplibre-gl-draw -->
<link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet">
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<!-- Draw Circle -->
<script src="https://unpkg.com/mapbox-gl-draw-circle@1.0.3/dist/mapbox-gl-draw-circle.js"></script>

<!-- FlatGeobuf -->
<script src="https://unpkg.com/flatgeobuf/dist/flatgeobuf-geojson.min.js"></script>

<!-- Yjs + y-webrtc -->
<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://unpkg.com/y-webrtc@10.6.6/dist/y-webrtc.js"></script>

<style>
  body, html, #map { margin:0; padding:0; height:100%; }
  .toolbar {
    position:absolute; top:60px; left:10px;
    background:white; padding:10px;
    border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15);
    font-family: sans-serif; z-index:999;
  }
  .toolbar strong { display:block; margin-bottom:6px; }
  .toolbar button {
    display:block; width:180px; margin:4px 0;
    padding:8px; font-size:15px;
    border:1px solid #ccc; border-radius:6px;
    background:#f8f8f8;
  }
  .toolbar button:hover { background:#e8e8e8; }
  .comment-label {
    background: rgba(255,255,255,0.7);
    border-radius: 4px;
    padding: 2px 4px;
    font-size: 12px;
    pointer-events: none;
  }
</style>
</head>
<body>

<div id="map"></div>
<div class="toolbar">
  <strong>PhnField</strong>
  <button id="btn-save-geojson">GeoJSONで保存</button>
  <button id="btn-save-fgb">FlatGeobufで保存</button>
  <button id="btn-clear">全削除</button>
  <button id="btn-toggle-labels">コメント表示切替</button>
  <button id="btn-toggle-basemap">地図切替(OSM/GSI)</button>
</div>

<script>
  const roomName = new URLSearchParams(location.search).get("room") || "default";

  // 背景地図
  const styleOSM = {
    version: 8,
    sources: {
      osm: {
        type: "raster",
        tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
        tileSize: 256,
        attribution: "© OpenStreetMap contributors"
      }
    },
    layers: [{ id: "osm", type: "raster", source: "osm" }]
  };
  const styleGSI = {
    version: 8,
    sources: {
      gsi: {
        type: "raster",
        tiles: ["https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"],
        tileSize: 256,
        attribution: "地理院タイル（<a href='https://maps.gsi.go.jp/development/ichiran.html'>出典</a>）"
      }
    },
    layers: [{ id: "gsi", type: "raster", source: "gsi" }]
  };
  let currentStyle = "GSI";

  const map = new maplibregl.Map({
    container: 'map',
    style: styleGSI,
    center: [135.8049, 34.6851],
    zoom: 13,
    attributionControl: true
  });
  map.addControl(new maplibregl.NavigationControl(), 'top-right');

  const Draw = new MapboxDraw({
    displayControlsDefault: false,
    controls: { point: true, line_string: true, polygon: true, trash: true },
    modes: Object.assign({ draw_circle: MapboxDraw.modes.draw_circle }, MapboxDraw.modes)
  });
  map.addControl(Draw, 'top-left');

  // ====== Yjs P2P同期（y-webrtc） ======
  const ydoc = new Y.Doc();
  const provider = new window.ywebrtc.WebrtcProvider("phnfield-" + roomName, ydoc, {
    signaling: ['wss://signaling.yjs.dev'],
    password: null,
    awareness: new Y.awarenessProtocol.Awareness(ydoc)
  });
  const yfeatures = ydoc.getArray("features");

  function syncFromY() {
    const data = yfeatures.toArray();
    Draw.deleteAll();
    if (data.length > 0) {
      Draw.add({ type: "FeatureCollection", features: data });
    }
    updateLabels();
  }
  function syncToY() {
    const fs = Draw.getAll().features;
    ydoc.transact(() => {
      yfeatures.delete(0, yfeatures.length);
      yfeatures.push(fs);
    });
  }
  yfeatures.observe(syncFromY);

  // ====== コメント表示 ======
  let showLabels = true;
  function updateLabels() {
    document.querySelectorAll('.mapboxgl-marker').forEach(m => m.remove());
    if (!showLabels) return;
    const features = Draw.getAll().features;
    features.forEach(f => {
      if (f.properties && f.properties.comment) {
        const el = document.createElement('div');
        el.className = 'comment-label';
        el.textContent = f.properties.comment;
        let coord;
        if (f.geometry.type === 'Point') coord = f.geometry.coordinates;
        else if (f.geometry.type === 'LineString') coord = f.geometry.coordinates[0];
        else coord = f.geometry.coordinates[0][0];
        new maplibregl.Marker({ element: el }).setLngLat(coord).addTo(map);
      }
    });
  }

  map.on('draw.create', e => {
    const id = e.features[0].id;
    const comment = prompt("コメントを入力してください（空欄可）");
    Draw.setFeatureProperty(id, 'comment', comment || '');
    syncToY();
  });
  map.on('draw.update', syncToY);
  map.on('draw.delete', syncToY);

  // ====== 保存 ======
  function download(filename, blob) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }
  document.getElementById('btn-save-geojson').onclick = () => {
    const fc = Draw.getAll();
    download('phnfield.geojson', new Blob([JSON.stringify(fc, null, 2)], {type: 'application/geo+json'}));
  };
  document.getElementById('btn-save-fgb').onclick = () => {
    const fc = Draw.getAll();
    const bytes = flatgeobuf.geojson.serialize(fc);
    download('phnfield.fgb', new Blob([bytes], {type:'application/octet-stream'}));
  };

  // ====== 全削除 ======
  document.getElementById('btn-clear').onclick = () => {
    if (confirm("全て削除しますか？")) {
      Draw.deleteAll();
      syncToY();
    }
  };

  // ====== コメント表示切替 ======
  document.getElementById('btn-toggle-labels').onclick = () => {
    showLabels = !showLabels;
    updateLabels();
  };

  // ====== 地図切替 ======
  document.getElementById('btn-toggle-basemap').onclick = () => {
    currentStyle = currentStyle === "GSI" ? "OSM" : "GSI";
    map.setStyle(currentStyle === "GSI" ? styleGSI : styleOSM);
  };
</script>

</body>
</html>
